<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lifetime policy impact</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 24px;
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 24px;
        }
        .header-content { flex: 1; }
        .header-logo img { opacity: 0.9; transition: opacity 0.15s; }
        .header-logo:hover img { opacity: 1; }
        h1 { font-size: 1.75rem; font-weight: 600; color: #1e293b; margin-bottom: 6px; }
        .subtitle { font-size: 1rem; color: #64748b; margin-bottom: 0; line-height: 1.6; }
        .layout { display: grid; grid-template-columns: 300px 1fr; gap: 24px; }

        .controls {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 24px;
        }
        .controls h2 { font-size: 0.95rem; font-weight: 600; margin-bottom: 16px; color: #1e293b; }
        .control-group { margin-bottom: 14px; }
        .control-group label {
            display: block;
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 500;
        }
        .control-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            background: #fff;
            color: #1e293b;
        }
        .control-group select:focus {
            outline: none;
            border-color: #0f766e;
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #e2e8f0;
            border-radius: 3px;
            cursor: pointer;
        }
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #0f766e;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .slider-container input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(15, 118, 110, 0.4);
        }
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #0f766e;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .slider-value {
            min-width: 65px;
            text-align: right;
            font-size: 0.85rem;
            font-weight: 500;
            color: #1e293b;
            font-variant-numeric: tabular-nums;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .summary-item {
            background: #fff;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-item.highlighted {
            background: linear-gradient(135deg, #0f766e 0%, #0d6560 100%);
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.25);
        }
        .summary-item.highlighted .summary-label { color: rgba(255,255,255,0.9); }
        .summary-item.highlighted .summary-value { color: #fff; }
        .summary-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f766e;
            font-variant-numeric: tabular-nums;
        }
        .summary-value.positive { color: #0f766e; }
        .summary-value.negative { color: #dc2626; }

        .chart-container {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .chart-watermark {
            display: flex;
            align-items: center;
        }
        .chart-watermark img { height: 24px; opacity: 0.5; transition: opacity 0.15s; }
        .chart-watermark:hover img { opacity: 0.8; }
        #chart { width: 100%; height: 400px; }
        .axis text { fill: #64748b; font-size: 11px; }
        .axis path, .axis line { stroke: #e2e8f0; }
        .grid line { stroke: #f1f5f9; }
        .legend { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 16px; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #475569; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }

        .download-buttons {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }
        .download-buttons-inner {
            display: flex;
            gap: 12px;
        }
        .download-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #0f766e;
            background: #fff;
            border: 1px solid #0f766e;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .download-btn:hover {
            background: #0f766e;
            color: #fff;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: #64748b;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #0f766e;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        .toggle-label {
            font-weight: 400;
            opacity: 0.5;
        }
        .toggle-label.active {
            font-weight: 600;
            opacity: 1;
        }
        .toggle-label.nominal {
            color: #64748b;
        }
        .toggle-label.real {
            color: #0f766e;
        }

        .tooltip {
            position: absolute;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.85rem;
            z-index: 100;
        }
        .tooltip-title { font-weight: 600; margin-bottom: 8px; color: #1e293b; }
        .tooltip-row { display: flex; justify-content: space-between; gap: 16px; margin: 3px 0; }
        .tooltip-label { color: #64748b; }
        .tooltip-value { font-weight: 500; }
        .tooltip-value.positive { color: #0f766e; }
        .tooltip-value.negative { color: #dc2626; }
        .tooltip-section { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
        .tooltip-reforms { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .tooltip-total { margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0; font-weight: 600; }

        .age-group rect { cursor: pointer; }

        /* Mobile responsive */
        @media (max-width: 900px) {
            body { padding: 16px; }
            .layout { grid-template-columns: 1fr; }
            .controls {
                position: static;
                margin-bottom: 16px;
            }
            .summary { grid-template-columns: 1fr 1fr; }
            #chart { height: 300px; }
            h1 { font-size: 1.5rem; }
        }
        @media (max-width: 480px) {
            body { padding: 12px; }
            .controls { padding: 16px; }
            .chart-container { padding: 16px; }
            .summary { grid-template-columns: 1fr; gap: 12px; }
            .summary-value { font-size: 1.3rem; }
            #chart { height: 280px; }
            .legend { gap: 10px; }
            .legend-item { font-size: 0.7rem; }
            h1 { font-size: 1.25rem; }
            .subtitle { font-size: 0.9rem; }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #fff;
            border-radius: 12px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; flex: 1; text-align: center; }
        .modal-nav {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 1.1rem;
            cursor: pointer;
            color: #374151;
            transition: all 0.15s ease;
        }
        .modal-nav:hover:not(:disabled) { background: #e5e7eb; }
        .modal-nav:disabled { opacity: 0.3; cursor: not-allowed; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
            margin-left: 8px;
        }
        .modal-close:hover { color: #333; }
        .modal-body { padding: 24px; }
        .modal-panel { min-height: 450px; max-height: 450px; overflow-y: auto; }
        .calc-section { margin-bottom: 24px; }
        .calc-section:last-child { margin-bottom: 0; }
        .calc-title { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .calc-dot { width: 10px; height: 10px; border-radius: 3px; }
        .calc-explanation { color: #666; font-size: 0.9rem; line-height: 1.6; margin-bottom: 12px; }
        .calc-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; }
        .calc-table td { padding: 6px 0; border-bottom: 1px solid #f0f0f0; }
        .calc-table td:last-child { text-align: right; font-family: monospace; }
        .calc-result { font-weight: 600; border-top: 2px solid #e5e5e5 !important; }
        .calc-result.positive { color: #16a34a; }
        .calc-result.negative { color: #dc2626; }

        .loading { text-align: center; padding: 40px; color: #888; }

        .tab-bar {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 0;
        }
        .detail-tab {
            padding: 10px 18px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #64748b;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .detail-tab:hover {
            color: #0f766e;
            background: #f0fdfa;
        }
        .detail-tab.active {
            color: #0f766e;
            font-weight: 600;
            border-bottom-color: #0f766e;
            background: transparent;
        }
        .detail-panel {
            min-height: 200px;
            padding-top: 16px;
        }

        .methodology {
            margin-top: 32px;
            padding: 24px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .methodology h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
        }
        .methodology h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            margin: 20px 0 10px 0;
        }
        .methodology p {
            font-size: 0.95rem;
            color: #475569;
            line-height: 1.7;
            margin-bottom: 12px;
        }
        .methodology ul {
            margin: 0;
            padding-left: 20px;
        }
        .methodology li {
            font-size: 0.9rem;
            color: #475569;
            line-height: 1.7;
            margin-bottom: 8px;
        }
        .methodology li strong {
            color: #1e293b;
        }
        .defaults-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin: 16px 0;
        }
        .defaults-table th, .defaults-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .defaults-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #1e293b;
        }
        .defaults-table td {
            color: #475569;
        }
        .defaults-table td:first-child {
            font-weight: 500;
            color: #1e293b;
        }
        .defaults-table td:nth-child(2) {
            font-family: monospace;
            white-space: nowrap;
        }
        .defaults-table td:nth-child(3) {
            font-size: 0.85rem;
            color: #64748b;
        }
        .defaults-table tbody tr:hover {
            background: #f8fafc;
        }
        .defaults-table a {
            color: #2C7A7B;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Lifetime policy impact</h1>
                <p class="subtitle">Model the impact of UK budget policy reforms over your lifetime</p>
            </div>
            <a href="https://policyengine.org" target="_blank" class="header-logo">
                <img src="assets/policyengine-logo.svg" alt="PolicyEngine" height="36">
            </a>
        </div>

        <div class="layout">
            <div class="controls">
                <h2>Household inputs (2025)</h2>

                <div class="control-group">
                    <label>Age</label>
                    <div class="slider-container">
                        <input type="range" id="current_age" value="22" min="18" max="80" step="1">
                        <span class="slider-value" id="current_age_value">22</span>
                    </div>
                </div>

                <div class="control-group">
                    <label title="Starting salary in graduation year. Grows with age-based earnings trajectory.">Salary</label>
                    <div class="slider-container">
                        <input type="range" id="current_salary" value="30000" min="0" max="200000" step="1000">
                        <span class="slider-value" id="current_salary_value">£30,000</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Retirement age</label>
                    <div class="slider-container">
                        <input type="range" id="retirement_age" value="67" min="55" max="100" step="1">
                        <span class="slider-value" id="retirement_age_value">67</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Life expectancy</label>
                    <div class="slider-container">
                        <input type="range" id="life_expectancy" value="85" min="60" max="100" step="1">
                        <span class="slider-value" id="life_expectancy_value">85</span>
                    </div>
                </div>

                <div class="control-group">
                    <label title="Initial debt at graduation. Evolves based on interest and repayments.">Student loan debt</label>
                    <div class="slider-container">
                        <input type="range" id="student_loan_debt" value="45000" min="0" max="100000" step="5000">
                        <span class="slider-value" id="student_loan_debt_value">£45,000</span>
                    </div>
                </div>

                <div class="control-group">
                    <label title="Annual pension contribution via salary sacrifice. Grows with CPI. Cap of £2k from April 2029.">Salary sacrifice</label>
                    <div class="slider-container">
                        <input type="range" id="salary_sacrifice_per_year" value="2000" min="0" max="10000" step="100">
                        <span class="slider-value" id="salary_sacrifice_per_year_value">£2,000</span>
                    </div>
                </div>

                <div class="control-group">
                    <label title="Annual rail spending (fixed nominal). Policy impact uses RPI fare growth.">Rail spending</label>
                    <div class="slider-container">
                        <input type="range" id="rail_spending_per_year" value="2000" min="0" max="10000" step="100">
                        <span class="slider-value" id="rail_spending_per_year_value">£2,000</span>
                    </div>
                </div>

                <div class="control-group">
                    <label title="Annual petrol spending (fixed nominal). Policy impact uses fuel duty changes.">Petrol spending</label>
                    <div class="slider-container">
                        <input type="range" id="petrol_spending_per_year" value="500" min="0" max="10000" step="100">
                        <span class="slider-value" id="petrol_spending_per_year_value">£500</span>
                    </div>
                </div>

                <div class="control-group">
                    <label title="Annual dividend income. Grows with CPI to maintain real value.">Dividends</label>
                    <div class="slider-container">
                        <input type="range" id="dividends_per_year" value="500" min="0" max="10000" step="100">
                        <span class="slider-value" id="dividends_per_year_value">£500</span>
                    </div>
                </div>

                <div class="control-group">
                    <label title="Annual savings interest income. Grows with CPI to maintain real value.">Savings interest</label>
                    <div class="slider-container">
                        <input type="range" id="savings_interest_per_year" value="500" min="0" max="10000" step="100">
                        <span class="slider-value" id="savings_interest_per_year_value">£500</span>
                    </div>
                </div>

                <div class="control-group">
                    <label title="Annual rental/property income. Grows with CPI to maintain real value.">Property income</label>
                    <div class="slider-container">
                        <input type="range" id="property_income_per_year" value="0" min="0" max="10000" step="100">
                        <span class="slider-value" id="property_income_per_year_value">£0</span>
                    </div>
                </div>
            </div>

            <div>
                <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
                    <div class="toggle-container" style="background: #fff; padding: 8px 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <span class="toggle-label nominal" id="nominal-label">Nominal</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="real-terms-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label real active" id="real-label">2025 £</span>
                    </div>
                </div>
                <div class="summary" id="summary"></div>
                <div class="chart-container">
                    <div id="chart"><div class="loading">Loading...</div></div>
                    <div class="legend" id="legend"></div>
                    <div class="download-buttons">
                        <div class="download-buttons-inner">
                            <button class="download-btn" id="download-svg">Download SVG</button>
                            <button class="download-btn" id="download-csv">Download CSV</button>
                        </div>
                        <div class="chart-watermark">
                            <a href="https://policyengine.org" target="_blank">
                                <img src="assets/policyengine-logo.svg" alt="PolicyEngine">
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="methodology">
            <h2>About this model</h2>
            <p>This tool estimates the lifetime financial impact of recent UK budget policy changes on a graduate entering the workforce. It models how various reforms affect take-home pay from age 22 until retirement, accounting for earnings growth, tax thresholds, and student loan repayments.</p>

            <h3>Policy reforms modelled</h3>
            <ul>
                <li><strong>Rail fare freeze</strong> — One-year freeze on rail fares in 2026, saving commuters the RPI increase they would otherwise have paid.</li>
                <li><strong>Fuel duty reform</strong> — The 5p cut extended to August 2026, then phased increases: +1p from September 2026, +2p from December 2026, +2p from March 2027. Compared to unfrozen baseline of 58p/litre.</li>
                <li><strong>Income tax threshold freeze</strong> — Extension of the freeze on personal allowance (£12,570) and basic rate threshold (£50,270) until 2030, rather than uprating with CPI from 2028.</li>
                <li><strong>Unearned income tax increase</strong> — 5% increase in tax on dividends, savings interest, and property income above allowances.</li>
                <li><strong>Salary sacrifice cap</strong> — £2,000 annual cap on salary sacrifice for pensions, with employee (8%) and employer (15%) NICs charged on contributions above this.</li>
                <li><strong>Student loan threshold freeze</strong> — Plan 2 repayment threshold frozen at £27,295 from 2027-2030, rather than rising with RPI. Debt written off after 30 years.</li>
            </ul>

            <h3>Default values</h3>
            <p>The default inputs represent a typical 2025 university graduate entering the workforce:</p>
            <table class="defaults-table">
                <thead>
                    <tr>
                        <th>Input</th>
                        <th>Default</th>
                        <th>Growth</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Age</td>
                        <td>22</td>
                        <td>—</td>
                        <td>Standard 3-year undergraduate degree completion age</td>
                    </tr>
                    <tr>
                        <td>Salary</td>
                        <td>£30,000</td>
                        <td>Earnings trajectory</td>
                        <td>Median UK graduate starting salary (<a href="https://www.highfliers.co.uk/download/2024/graduate_market/GMReport24.pdf" target="_blank">High Fliers 2024</a>)</td>
                    </tr>
                    <tr>
                        <td>Student loan debt</td>
                        <td>£45,000</td>
                        <td>RPI+3% − repayments</td>
                        <td>Typical Plan 2 debt after 3-year English degree</td>
                    </tr>
                    <tr>
                        <td>Salary sacrifice</td>
                        <td>£2,000</td>
                        <td>CPI</td>
                        <td>Lifetime average; matches NIC-exempt threshold from April 2029</td>
                    </tr>
                    <tr>
                        <td>Rail spending</td>
                        <td>£2,000</td>
                        <td>Fixed (RPI for impact)</td>
                        <td>Annual commuting costs for urban rail users</td>
                    </tr>
                    <tr>
                        <td>Petrol spending</td>
                        <td>£500</td>
                        <td>Fixed</td>
                        <td>Many graduates don't own cars or drive infrequently</td>
                    </tr>
                    <tr>
                        <td>Dividends</td>
                        <td>£500</td>
                        <td>CPI</td>
                        <td>Lifetime average in 2025 £; represents gradual portfolio accumulation</td>
                    </tr>
                    <tr>
                        <td>Savings interest</td>
                        <td>£500</td>
                        <td>CPI</td>
                        <td>Lifetime average in 2025 £; ~£12,500 at 4% initially, growing over time</td>
                    </tr>
                    <tr>
                        <td>Property income</td>
                        <td>£0</td>
                        <td>CPI</td>
                        <td>Most people don't receive rental income</td>
                    </tr>
                </tbody>
            </table>

            <h3>Assumptions</h3>
            <ul>
                <li>Graduate starts work at age 22 with the specified starting salary in their graduation year. The model simulates from 2026 onwards (when Autumn Budget policies take effect), so a 2020 graduate would be 28 years old in 2026.</li>
                <li>Earnings grow with age following typical career progression, plateauing at 2.2x starting salary from age 50.</li>
                <li>CPI inflation follows <a href="https://obr.uk/efo/economic-and-fiscal-outlook-november-2025/" target="_blank">OBR forecasts</a> then 2% long-term; RPI follows OBR forecasts then 2.39% long-term.</li>
                <li>State pension uses <a href="https://media.quilter.com/search/state-pension-just-15p-shy-of-breaching-tax-allowances-in-2026-forecasts-obr/" target="_blank">OBR projections</a> for 2024-2027 (triple lock applied), then grows at 4% annually — based on OBR's <a href="https://obr.uk/frs/fiscal-risks-and-sustainability-july-2025/" target="_blank">fiscal sustainability analysis</a> showing the triple lock averages ~0.5pp above earnings growth (2% productivity + 2% CPI target ≈ 4% earnings).</li>
                <li>Unearned income (dividends, savings interest, property income) grows with CPI to maintain real value.</li>
                <li>Positive values (green) indicate the reform makes you better off; negative (red) means worse off.</li>
            </ul>

            <h3>Caveats</h3>
            <ul>
                <li><strong>Policies not modelled</strong> — Several Autumn Budget measures are not included in this tool, such as the two-child benefit limit repeal, changes to inheritance tax, employer NICs increases (which may affect wages indirectly), and various business tax changes. The model currently assumes a childless individual.</li>
                <li><strong>Policy interactions</strong> — Each reform is modelled independently. In practice, some policies may interact in ways not fully captured (e.g., threshold freezes affecting multiple taxes simultaneously, or behavioural responses to policy changes).</li>
                <li><strong>Simplified calculations</strong> — This is a stylised model using representative assumptions. Individual circumstances will vary significantly based on actual career paths, location, housing costs, family composition, and financial decisions.</li>
                <li><strong>Long-term projections</strong> — Forecasts extending decades into the future are inherently uncertain. Actual policy, inflation, and earnings paths will differ from OBR projections.</li>
            </ul>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-nav" id="modal-prev" title="Previous year">&larr;</button>
                <div class="modal-title" id="modal-title">Age 30</div>
                <button class="modal-nav" id="modal-next" title="Next year">&rarr;</button>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <!-- Config: set API_URL before loading main script -->
    <script>
        // For production, replace this URL with your Cloud Run backend URL
        // Or set window.API_URL in a separate config.js file
        window.API_URL = window.API_URL || 'https://uk-autumn-budget-lifecycle-578039519715.europe-west1.run.app';
    </script>
    <script>
        const API_URL = window.API_URL;

        const reforms = [
            { key: 'impact_rail_fare_freeze', label: 'Rail fare freeze', color: '#3b82f6' },
            { key: 'impact_fuel_duty_freeze', label: 'Fuel duty freeze', color: '#eab308' },
            { key: 'impact_threshold_freeze', label: 'Threshold freeze', color: '#ef4444' },
            { key: 'impact_unearned_income_tax', label: 'Unearned income tax', color: '#8b5cf6' },
            { key: 'impact_salary_sacrifice_cap', label: 'Salary sacrifice cap', color: '#14b8a6' },
            { key: 'impact_sl_threshold_freeze', label: 'SL threshold freeze', color: '#f97316' }
        ];

        // Map reform keys to tab names for click-to-tab functionality
        const reformKeyToTab = {
            'impact_rail_fare_freeze': 'rail-fare',
            'impact_fuel_duty_freeze': 'fuel-duty',
            'impact_threshold_freeze': 'tax',
            'impact_unearned_income_tax': 'unearned-income',
            'impact_salary_sacrifice_cap': 'salary-sacrifice',
            'impact_sl_threshold_freeze': 'student-loan'
        };

        let currentData = [];
        let previousData = [];
        const ANIMATION_DURATION = 400;

        // CPI forecasts for deflating to 2025 terms
        // Source: OBR Economic and Fiscal Outlook
        const CPI_FORECASTS = {2024: 0.0233, 2025: 0.0318, 2026: 0.0193, 2027: 0.0200, 2028: 0.0200, 2029: 0.0200};
        const CPI_LONG_TERM = 0.0200;

        // Track real vs nominal display mode (default: real/2025 terms)
        let showRealTerms = true;

        // Calculate cumulative inflation from 2025 to target year
        function getCumulativeInflation(targetYear) {
            if (targetYear <= 2025) return 1.0;
            let factor = 1.0;
            for (let y = 2025; y < targetYear; y++) {
                const rate = CPI_FORECASTS[y] || CPI_LONG_TERM;
                factor *= (1 + rate);
            }
            return factor;
        }

        // Convert nominal value to 2025 real terms
        function toRealTerms(value, year) {
            if (!showRealTerms) return value;
            const inflationFactor = getCumulativeInflation(year);
            return value / inflationFactor;
        }

        // Format value with optional real terms conversion
        function formatValue(value, year) {
            const adjusted = toRealTerms(value, year);
            return `£${d3.format(',.0f')(adjusted)}`;
        }

        // Get terms suffix for labels
        function getTermsSuffix() {
            return showRealTerms ? ' (2025 £)' : '';
        }

        // Get adjusted data for display (applies real terms conversion if enabled)
        function getDisplayData() {
            if (!showRealTerms) return currentData;
            return currentData.map(row => {
                const deflator = getCumulativeInflation(row.year);
                const adjusted = { ...row };
                // Deflate all monetary values for chart display
                reforms.forEach(r => {
                    adjusted[r.key] = row[r.key] / deflator;
                });
                adjusted.gross_income = row.gross_income / deflator;
                adjusted.baseline_net_income = row.baseline_net_income / deflator;
                adjusted.income_tax = row.income_tax / deflator;
                adjusted.national_insurance = row.national_insurance / deflator;
                adjusted.student_loan_payment = row.student_loan_payment / deflator;
                adjusted.student_loan_debt_remaining = row.student_loan_debt_remaining / deflator;
                // Note: threshold parameters (baseline_pa, reform_pa, etc.) are NOT deflated here
                // Modal calculations use raw nominal values and apply toRealTerms() for display
                return adjusted;
            });
        }

        // Format signed currency values as +£X or -£X (not £+X or £-X)
        const formatSignedCurrency = (v) => {
            const absVal = d3.format(',.0f')(Math.abs(v));
            return v >= 0 ? `+£${absVal}` : `-£${absVal}`;
        };

        // Format slider values for display
        function formatSliderValue(id, value) {
            const v = parseFloat(value);
            if (id === 'current_age' || id === 'retirement_age' || id === 'life_expectancy') {
                return v.toString();
            }
            return `£${d3.format(',.0f')(v)}`;
        }

        // Update slider value displays
        function updateSliderDisplay(id) {
            const slider = document.getElementById(id);
            const display = document.getElementById(`${id}_value`);
            if (slider && display) {
                display.textContent = formatSliderValue(id, slider.value);
            }
        }

        // URL parameter management for shareable links
        const SLIDER_IDS = [
            'current_age', 'current_salary', 'retirement_age', 'life_expectancy', 'student_loan_debt',
            'salary_sacrifice_per_year', 'rail_spending_per_year', 'petrol_spending_per_year',
            'dividends_per_year', 'savings_interest_per_year', 'property_income_per_year'
        ];

        function getUrlParams() {
            return new URLSearchParams(window.location.search);
        }

        function updateUrlParams() {
            const params = new URLSearchParams();
            SLIDER_IDS.forEach(id => {
                const slider = document.getElementById(id);
                if (slider) {
                    const defaultVal = slider.getAttribute('data-default');
                    // Only include in URL if different from default
                    if (slider.value !== defaultVal) {
                        params.set(id, slider.value);
                    }
                }
            });
            const newUrl = params.toString()
                ? `${window.location.pathname}?${params.toString()}`
                : window.location.pathname;
            window.history.replaceState({}, '', newUrl);
        }

        function loadFromUrlParams() {
            const params = getUrlParams();
            SLIDER_IDS.forEach(id => {
                const slider = document.getElementById(id);
                if (slider) {
                    // Store default value for comparison later
                    slider.setAttribute('data-default', slider.value);
                    // Load from URL if present
                    const urlValue = params.get(id);
                    if (urlValue !== null) {
                        const numVal = parseFloat(urlValue);
                        const min = parseFloat(slider.min);
                        const max = parseFloat(slider.max);
                        // Validate within range
                        if (!isNaN(numVal) && numVal >= min && numVal <= max) {
                            slider.value = urlValue;
                        }
                    }
                }
            });
        }

        // Initialize all slider displays
        function initSliders() {
            // First load values from URL params
            loadFromUrlParams();
            // Then set up displays and event listeners
            SLIDER_IDS.forEach(id => {
                const slider = document.getElementById(id);
                if (slider) {
                    updateSliderDisplay(id);
                    slider.addEventListener('input', () => {
                        updateSliderDisplay(id);
                        updateUrlParams();
                    });
                }
            });
        }

        function getInputs() {
            return {
                current_age: parseInt(document.getElementById('current_age').value),
                current_salary: parseFloat(document.getElementById('current_salary').value),
                retirement_age: parseInt(document.getElementById('retirement_age').value),
                life_expectancy: parseInt(document.getElementById('life_expectancy').value),
                student_loan_debt: parseFloat(document.getElementById('student_loan_debt').value),
                salary_sacrifice_per_year: parseFloat(document.getElementById('salary_sacrifice_per_year').value),
                rail_spending_per_year: parseFloat(document.getElementById('rail_spending_per_year').value),
                petrol_spending_per_year: parseFloat(document.getElementById('petrol_spending_per_year').value),
                dividends_per_year: parseFloat(document.getElementById('dividends_per_year').value),
                savings_interest_per_year: parseFloat(document.getElementById('savings_interest_per_year').value),
                property_income_per_year: parseFloat(document.getElementById('property_income_per_year').value),
            };
        }

        async function fetchData() {
            const inputs = getInputs();
            try {
                const response = await fetch(`${API_URL}/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                const result = await response.json();
                previousData = currentData;
                currentData = result.data;
                renderChart(previousData.length > 0);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('chart').innerHTML = '<div class="loading">Error loading data. Is the API running?</div>';
            }
        }

        function renderChart(animate = false) {
            const data = getDisplayData();
            if (!data.length) return;

            const container = document.getElementById('chart');
            const existingSvg = d3.select('#chart svg');
            const isUpdate = existingSvg.size() > 0 && animate;

            // Summary - always update with animation
            document.getElementById('summary').innerHTML = '';
            const totals = {};
            reforms.forEach(r => totals[r.key] = d3.sum(data, d => d[r.key]));
            const netTotal = d3.sum(Object.values(totals));
            const avgPerYear = netTotal / data.length;

            const summaryEl = d3.select('#summary');

            // Labels change based on real/nominal mode
            const termsLabel = showRealTerms ? ' (2025 £)' : '';

            // Net lifetime impact (highlighted)
            const summaryItem = summaryEl.append('div').attr('class', 'summary-item highlighted');
            summaryItem.append('div').attr('class', 'summary-label').text('Net lifetime impact' + termsLabel);
            const summaryValue = summaryItem.append('div')
                .attr('class', 'summary-value');

            // Average per year
            const avgItem = summaryEl.append('div').attr('class', 'summary-item');
            avgItem.append('div').attr('class', 'summary-label').text('Average per year' + termsLabel);
            const avgValue = avgItem.append('div')
                .attr('class', `summary-value ${avgPerYear >= 0 ? 'positive' : 'negative'}`);

            // Animate the summary numbers
            if (animate && previousData.length > 0) {
                const prevTotals = {};
                reforms.forEach(r => prevTotals[r.key] = d3.sum(previousData, d => d[r.key] || 0));
                const prevNetTotal = d3.sum(Object.values(prevTotals));
                const prevAvgPerYear = previousData.length > 0 ? prevNetTotal / previousData.length : 0;

                summaryValue.transition()
                    .duration(ANIMATION_DURATION)
                    .tween('text', function() {
                        const i = d3.interpolateNumber(prevNetTotal, netTotal);
                        return function(t) {
                            this.textContent = formatSignedCurrency(i(t));
                        };
                    });

                avgValue.transition()
                    .duration(ANIMATION_DURATION)
                    .tween('text', function() {
                        const i = d3.interpolateNumber(prevAvgPerYear, avgPerYear);
                        return function(t) {
                            this.textContent = formatSignedCurrency(i(t));
                        };
                    });
            } else {
                summaryValue.text(formatSignedCurrency(netTotal));
                avgValue.text(formatSignedCurrency(avgPerYear));
            }

            // Chart dimensions
            const margin = { top: 20, right: 20, bottom: 40, left: 60 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            // Prepare stacked data
            const stackedData = data.map(d => {
                let posY = 0, negY = 0;
                const bars = reforms.map(r => {
                    const value = d[r.key];
                    const bar = { key: r.key, value, age: d.age, year: d.year };
                    if (value >= 0) {
                        bar.y0 = posY;
                        bar.y1 = posY + value;
                        posY += value;
                    } else {
                        bar.y1 = negY;
                        bar.y0 = negY + value;
                        negY += value;
                    }
                    return bar;
                });
                const netImpact = posY + negY;
                return {
                    age: d.age,
                    year: d.year,
                    bars,
                    posTotal: posY,
                    negTotal: negY,
                    netImpact,
                    // Include full row data for tooltip
                    gross_income: d.gross_income,
                    income_tax: d.income_tax,
                    national_insurance: d.national_insurance,
                    student_loan_payment: d.student_loan_payment,
                    student_loan_debt_remaining: d.student_loan_debt_remaining,
                    baseline_net_income: d.baseline_net_income
                };
            });

            const yMax = d3.max(stackedData, d => d.posTotal);
            const yMin = d3.min(stackedData, d => d.negTotal);
            // Make y-axis symmetric about 0
            const yExtent = Math.max(Math.abs(yMax), Math.abs(yMin)) * 1.1;

            const x = d3.scaleBand()
                .domain(data.map(d => d.age))
                .range([0, width])
                .padding(0.15);

            const y = d3.scaleLinear()
                .domain([-yExtent, yExtent])
                .range([height, 0]);

            let svg, chartG;

            if (isUpdate) {
                // Update existing chart with transitions
                svg = existingSvg;
                chartG = svg.select('g');

                // Update y-axis with transition
                chartG.select('.axis.y-axis')
                    .transition()
                    .duration(ANIMATION_DURATION)
                    .call(d3.axisLeft(y).tickFormat(d => formatSignedCurrency(d)).ticks(8));

                // Update grid
                chartG.select('.grid')
                    .transition()
                    .duration(ANIMATION_DURATION)
                    .call(d3.axisLeft(y).tickSize(-width).tickFormat('').ticks(8));

                // Update zero line
                chartG.select('.zero-line')
                    .transition()
                    .duration(ANIMATION_DURATION)
                    .attr('y1', y(0))
                    .attr('y2', y(0));

                // Update bars with animation
                const ageGroups = chartG.selectAll('.age-group')
                    .data(stackedData, d => d.age);

                // Handle age groups that might be added/removed (retirement age change)
                const enterGroups = ageGroups.enter()
                    .append('g')
                    .attr('class', 'age-group')
                    .attr('transform', d => `translate(${x(d.age)},0)`);

                enterGroups.selectAll('rect')
                    .data(d => d.bars)
                    .enter()
                    .append('rect')
                    .attr('x', 0)
                    .attr('y', y(0))
                    .attr('width', x.bandwidth())
                    .attr('height', 0)
                    .attr('fill', d => reforms.find(r => r.key === d.key).color)
                    .attr('rx', 1);

                // Remove old groups
                ageGroups.exit()
                    .transition()
                    .duration(ANIMATION_DURATION)
                    .style('opacity', 0)
                    .remove();

                // Update existing groups
                ageGroups.transition()
                    .duration(ANIMATION_DURATION)
                    .attr('transform', d => `translate(${x(d.age)},0)`);

                // Update rects in all groups
                chartG.selectAll('.age-group').each(function(groupData) {
                    const group = d3.select(this);
                    const rects = group.selectAll('rect').data(groupData.bars);

                    rects.enter()
                        .append('rect')
                        .attr('x', 0)
                        .attr('y', y(0))
                        .attr('width', x.bandwidth())
                        .attr('height', 0)
                        .attr('fill', d => reforms.find(r => r.key === d.key).color)
                        .attr('rx', 1)
                        .merge(rects)
                        .transition()
                        .duration(ANIMATION_DURATION)
                        .attr('width', x.bandwidth())
                        .attr('y', d => y(Math.max(d.y0, d.y1)))
                        .attr('height', d => Math.abs(y(d.y0) - y(d.y1)));
                });

                // Update x-axis
                chartG.select('.axis.x-axis')
                    .transition()
                    .duration(ANIMATION_DURATION)
                    .call(d3.axisBottom(x).tickValues(data.filter(d => d.age % 5 === 0).map(d => d.age)));

                // Update top x-axis - move year ticks to new positions
                const yearTicks = [2025, 2030, 2035, 2040, 2045, 2050, 2055, 2060, 2065, 2070, 2075, 2080, 2085, 2090, 2095, 2100];
                chartG.select('.axis.x-axis-top').selectAll('.year-tick')
                    .data(yearTicks, d => d)
                    .transition()
                    .duration(ANIMATION_DURATION)
                    .attr('transform', year => {
                        const row = data.find(r => r.year === year);
                        const xPos = row ? x(row.age) + x.bandwidth() / 2 : -100;
                        return `translate(${xPos},0)`;
                    })
                    .style('opacity', year => {
                        const row = data.find(r => r.year === year);
                        return row ? 1 : 0;
                    });

                // Update net impact line
                const line = d3.line()
                    .x(d => x(d.age) + x.bandwidth() / 2)
                    .y(d => y(d.netImpact))
                    .curve(d3.curveMonotoneX);

                chartG.select('.net-line')
                    .datum(stackedData)
                    .transition()
                    .duration(ANIMATION_DURATION)
                    .attr('d', line);

            } else {
                // Initial render
                document.getElementById('chart').innerHTML = '';
                document.getElementById('legend').innerHTML = '';

                svg = d3.select('#chart')
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom);

                chartG = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                chartG.append('g')
                    .attr('class', 'grid')
                    .call(d3.axisLeft(y).tickSize(-width).tickFormat('').ticks(8));

                chartG.append('line')
                    .attr('class', 'zero-line')
                    .attr('x1', 0).attr('x2', width)
                    .attr('y1', y(0)).attr('y2', y(0))
                    .attr('stroke', '#333')
                    .attr('stroke-width', 2);

                const ageGroups = chartG.selectAll('.age-group')
                    .data(stackedData, d => d.age)
                    .enter()
                    .append('g')
                    .attr('class', 'age-group')
                    .attr('transform', d => `translate(${x(d.age)},0)`);

                ageGroups.selectAll('rect')
                    .data(d => d.bars)
                    .enter()
                    .append('rect')
                    .attr('x', 0)
                    .attr('y', y(0))
                    .attr('width', x.bandwidth())
                    .attr('height', 0)
                    .attr('fill', d => reforms.find(r => r.key === d.key).color)
                    .attr('rx', 1)
                    .transition()
                    .duration(ANIMATION_DURATION)
                    .attr('y', d => y(Math.max(d.y0, d.y1)))
                    .attr('height', d => Math.abs(y(d.y0) - y(d.y1)));

                chartG.append('g')
                    .attr('class', 'axis x-axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickValues(data.filter(d => d.age % 5 === 0).map(d => d.age)));

                // Top x-axis with fiscal year (e.g. 2029/30 shown as "29")
                // Use custom tick rendering for smooth position transitions
                const topAxisG = chartG.append('g')
                    .attr('class', 'axis x-axis-top');

                // Add axis line
                topAxisG.append('line')
                    .attr('class', 'domain')
                    .attr('x1', 0)
                    .attr('x2', width)
                    .attr('stroke', '#e2e8f0');

                // Add year ticks as individual groups
                const yearTicks = [2025, 2030, 2035, 2040, 2045, 2050, 2055, 2060, 2065, 2070, 2075, 2080, 2085, 2090, 2095, 2100];
                topAxisG.selectAll('.year-tick')
                    .data(yearTicks, d => d)
                    .enter()
                    .append('g')
                    .attr('class', 'year-tick')
                    .attr('transform', year => {
                        const row = data.find(r => r.year === year);
                        const xPos = row ? x(row.age) + x.bandwidth() / 2 : -100;
                        return `translate(${xPos},0)`;
                    })
                    .each(function(year) {
                        const g = d3.select(this);
                        g.append('line').attr('y2', -6).attr('stroke', '#e2e8f0');
                        g.append('text')
                            .attr('y', -9)
                            .attr('text-anchor', 'middle')
                            .attr('fill', '#64748b')
                            .attr('font-size', '11px')
                            .text(year);
                    })
                    .style('opacity', year => {
                        const row = data.find(r => r.year === year);
                        return row ? 1 : 0;
                    });

                chartG.append('g')
                    .attr('class', 'axis y-axis')
                    .call(d3.axisLeft(y).tickFormat(d => formatSignedCurrency(d)).ticks(8));

                // Net impact line
                const line = d3.line()
                    .x(d => x(d.age) + x.bandwidth() / 2)
                    .y(d => y(d.netImpact))
                    .curve(d3.curveMonotoneX);

                chartG.append('path')
                    .datum(stackedData)
                    .attr('class', 'net-line')
                    .attr('fill', 'none')
                    .attr('stroke', '#1a1a1a')
                    .attr('stroke-width', 2.5)
                    .attr('stroke-dasharray', function() {
                        const length = this.getTotalLength ? this.getTotalLength() : 0;
                        return `${length} ${length}`;
                    })
                    .attr('stroke-dashoffset', function() {
                        return this.getTotalLength ? this.getTotalLength() : 0;
                    })
                    .attr('d', line)
                    .transition()
                    .duration(ANIMATION_DURATION * 2)
                    .attr('stroke-dashoffset', 0);

                // Legend
                const legend = d3.select('#legend');
                reforms.forEach(r => {
                    legend.append('div')
                        .attr('class', 'legend-item')
                        .html(`<div class="legend-color" style="background:${r.color}"></div><span>${r.label}</span>`);
                });
                // Add net impact to legend
                legend.append('div')
                    .attr('class', 'legend-item')
                    .html(`<div class="legend-color" style="background:#1a1a1a"></div><span>Net impact</span>`);
            }

            // Rebind tooltip and click events
            chartG.selectAll('.age-group')
                .data(stackedData, d => d.age)
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1);
                    let html = `<div class="tooltip-title">Age ${d.age} (${d.year})</div>`;

                    // Model details section
                    html += `<div class="tooltip-section">`;
                    html += `<div class="tooltip-row"><span class="tooltip-label">Gross income</span><span class="tooltip-value">£${d3.format(',.0f')(d.gross_income)}</span></div>`;
                    if (d.income_tax > 0) {
                        html += `<div class="tooltip-row"><span class="tooltip-label">Income tax</span><span class="tooltip-value">-£${d3.format(',.0f')(d.income_tax)}</span></div>`;
                    }
                    if (d.national_insurance > 0) {
                        html += `<div class="tooltip-row"><span class="tooltip-label">National insurance</span><span class="tooltip-value">-£${d3.format(',.0f')(d.national_insurance)}</span></div>`;
                    }
                    if (d.student_loan_payment > 0) {
                        html += `<div class="tooltip-row"><span class="tooltip-label">Student loan</span><span class="tooltip-value">-£${d3.format(',.0f')(d.student_loan_payment)}</span></div>`;
                    }
                    if (d.student_loan_debt_remaining > 0) {
                        html += `<div class="tooltip-row"><span class="tooltip-label">SL debt remaining</span><span class="tooltip-value">£${d3.format(',.0f')(d.student_loan_debt_remaining)}</span></div>`;
                    }
                    html += `</div>`;

                    // Reform impacts section
                    const activeReforms = d.bars.filter(b => b.value !== 0);
                    if (activeReforms.length > 0) {
                        html += `<div class="tooltip-section tooltip-reforms">`;
                        activeReforms.forEach(bar => {
                            const reform = reforms.find(r => r.key === bar.key);
                            html += `<div class="tooltip-row">
                                <span class="tooltip-label">${reform.label}</span>
                                <span class="tooltip-value ${bar.value >= 0 ? 'positive' : 'negative'}">${formatSignedCurrency(bar.value)}</span>
                            </div>`;
                        });
                        html += `</div>`;
                    }

                    const total = d3.sum(d.bars, b => b.value);
                    html += `<div class="tooltip-row tooltip-total">
                        <span>Net policy impact</span>
                        <span class="tooltip-value ${total >= 0 ? 'positive' : 'negative'}">${formatSignedCurrency(total)}</span>
                    </div>`;
                    html += `<div style="margin-top: 8px; font-size: 0.75rem; color: #94a3b8; text-align: center;">Click for details</div>`;
                    tooltip.html(html);
                })
                .on('mousemove', function(event) {
                    tooltip.style('left', (event.pageX + 10) + 'px').style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    // Determine which bar segment was clicked based on mouse Y position
                    const mouseY = d3.pointer(event, this)[1];
                    let clickedTab = 'summary';

                    // Find which bar segment was clicked
                    for (const bar of d.bars) {
                        if (bar.value === 0) continue;
                        const barTop = y(Math.max(bar.y0, bar.y1));
                        const barBottom = y(Math.min(bar.y0, bar.y1));
                        if (mouseY >= barTop && mouseY <= barBottom) {
                            clickedTab = reformKeyToTab[bar.key] || 'summary';
                            break;
                        }
                    }

                    showModal(d.age, clickedTab);
                });
        }

        // Common table styling
        const tableStyle = `
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        `;
        const thStyle = `
            padding: 10px 12px;
            text-align: right;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            color: #1e293b;
        `;
        const tdStyle = `
            padding: 8px 12px;
            text-align: right;
            border-bottom: 1px solid #f1f5f9;
        `;
        const labelStyle = `
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
            color: #64748b;
        `;

        // Global RPI function for use in multiple render functions
        const RPI_FORECASTS = {2024: 0.0331, 2025: 0.0416, 2026: 0.0308, 2027: 0.0300, 2028: 0.0283, 2029: 0.0283};
        const RPI_LONG_TERM = 0.0239;
        function getRPI(y) { return RPI_FORECASTS[y] || RPI_LONG_TERM; }

        function formatDiff(diff) {
            const sign = diff >= 0 ? '+' : '-';
            return `<span style="font-weight: 600;">${sign}£${d3.format(',.0f')(Math.abs(diff))}</span>`;
        }

        function renderTaxDetailChart(selectedAge) {
            // Use currentData (nominal values) for consistent tax calculations
            // Then apply toRealTerms() only for display purposes
            if (!currentData.length) return;

            const row = currentData.find(d => d.age === selectedAge);
            const deflator = getCumulativeInflation(row?.year || 2026);
            if (!row || row.gross_income === 0) {
                document.getElementById('tax-detail-chart').innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No income at this age (retired)</div>';
                return;
            }

            const container = document.getElementById('tax-detail-chart');
            const income = row.gross_income;
            const year = row.year;

            // Policy takes effect from 2028 (when original freeze was due to end)
            if (year < 2028) {
                container.innerHTML = `<div style="text-align: center; color: #64748b; padding: 40px;">
                    <div style="font-size: 1.1rem; margin-bottom: 8px;">Policy not yet active</div>
                    <div style="font-size: 0.85rem;">The threshold freeze extension takes effect from 2028 when the original freeze was due to end. In ${year}, both scenarios are identical.</div>
                </div>`;
                return;
            }

            // Calculate effective PA after taper for both scenarios
            // Note: Taper threshold is NOT frozen, so it's the same in both scenarios
            const calcEffectivePA = (pa, taperThreshold) => {
                if (income > taperThreshold) {
                    const reduction = Math.min(pa, (income - taperThreshold) * 0.5);
                    return Math.max(0, pa - reduction);
                }
                return pa;
            };

            const baselineEffectivePA = calcEffectivePA(row.baseline_pa, row.baseline_taper_threshold);
            const reformEffectivePA = calcEffectivePA(row.reform_pa, row.reform_taper_threshold);

            // Calculate income in each band for each scenario
            const calcBands = (effectivePA, basicThreshold, additionalThreshold) => {
                let remaining = income;

                // Tax-free (effective PA)
                const taxFree = Math.min(remaining, effectivePA);
                remaining -= taxFree;

                // Basic rate band (20%)
                const basicBand = Math.max(0, Math.min(remaining, basicThreshold - effectivePA));
                remaining -= basicBand;

                // Higher rate band (40%)
                const higherBand = Math.max(0, Math.min(remaining, additionalThreshold - basicThreshold));
                remaining -= higherBand;

                // Additional rate band (45%)
                const additionalBand = Math.max(0, remaining);

                const tax = basicBand * 0.20 + higherBand * 0.40 + additionalBand * 0.45;

                return { taxFree, basicBand, higherBand, additionalBand, tax };
            };

            const baselineBands = calcBands(baselineEffectivePA, row.baseline_basic_threshold, row.baseline_additional_threshold);
            const reformBands = calcBands(reformEffectivePA, row.reform_basic_threshold, row.reform_additional_threshold);

            // Combined rows with section headers
            const allRows = [
                { section: 'Policy parameters (affected by freeze)' },
                { label: 'Personal allowance', preAB: row.baseline_pa, postAB: row.reform_pa },
                { label: 'Basic rate threshold', preAB: row.baseline_basic_threshold, postAB: row.reform_basic_threshold },
                { label: 'Additional rate threshold', preAB: row.baseline_additional_threshold, postAB: row.reform_additional_threshold },
                { section: 'Tax calculation' },
                { label: 'Effective personal allowance', preAB: baselineEffectivePA, postAB: reformEffectivePA, note: income > row.baseline_taper_threshold ? `(PA − 50% of income over £100k)` : '' },
                { label: 'Income taxed at 0%', preAB: baselineBands.taxFree, postAB: reformBands.taxFree },
                { label: 'Income taxed at 20%', preAB: baselineBands.basicBand, postAB: reformBands.basicBand },
                { label: 'Income taxed at 40%', preAB: baselineBands.higherBand, postAB: reformBands.higherBand },
                { label: 'Income taxed at 45%', preAB: baselineBands.additionalBand, postAB: reformBands.additionalBand },
                { separator: true },
                { label: 'Total income tax', preAB: baselineBands.tax, postAB: reformBands.tax, highlight: true },
            ];

            let tableHtml = `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle} text-align: left; width: 50%;">Item</th>
                            <th style="${thStyle} width: 16.67%;">Pre-AB</th>
                            <th style="${thStyle} width: 16.67%;">Post-AB</th>
                            <th style="${thStyle} width: 16.67%;">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allRows.forEach(r => {
                if (r.section) {
                    tableHtml += `<tr><td colspan="4" style="padding: 12px 8px 6px; font-weight: 600; font-size: 0.85rem; color: #475569; background: #f8fafc;">${r.section}</td></tr>`;
                } else if (r.separator) {
                    tableHtml += `<tr><td colspan="4" style="padding: 4px;"></td></tr>`;
                } else {
                    const preABReal = toRealTerms(r.preAB, year);
                    const postABReal = toRealTerms(r.postAB, year);
                    const diff = postABReal - preABReal;
                    const rowStyle = r.highlight ? 'background: #fef2f2;' : '';
                    tableHtml += `
                        <tr style="${rowStyle}">
                            <td style="${labelStyle} ${r.highlight ? 'font-weight: 600; color: #1e293b;' : ''}">${r.label}${r.note ? `<br><span style="font-size: 0.75rem; color: #94a3b8;">${r.note}</span>` : ''}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(preABReal)}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(postABReal)}</td>
                            <td style="${tdStyle}">${formatDiff(diff)}</td>
                        </tr>
                    `;
                }
            });

            tableHtml += `</tbody></table>`;

            const termsLabel = getTermsSuffix();
            let html = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <span style="font-weight: 600; color: #1e293b;">Year ${year}${termsLabel}</span>
                            <span style="color: #64748b; margin-left: 12px;">Gross income: £${d3.format(',.0f')(toRealTerms(income, year))}</span>
                        </div>
                    </div>
                    ${tableHtml}
                    <div style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">
                        <strong>How it works:</strong> Pre-AB, PA/basic/additional thresholds would rise with CPI from 2028. Post-AB, they remain frozen until 2030-31, then rise with CPI. The PA taper threshold (£100k) is never uprated - it's been fixed since 2009.
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // Student loan detail chart
        function renderStudentLoanDetail(selectedAge, targetContainer = null) {
            const data = getDisplayData();
            if (!data.length) return;

            const row = data.find(d => d.age === selectedAge);
            const container = targetContainer || document.getElementById('student-loan-detail');
            if (!container) return;
            const deflator = getCumulativeInflation(row?.year || 2026);

            if (!row) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No data for this age</div>';
                return;
            }

            const income = row.gross_income;
            const year = row.year;
            const inputs = getInputs();
            // Years since graduation (assuming graduation at age 22)
            const yearsFromGrad = row.age - 22;

            // Policy takes effect from 2027 (when threshold was due to be uprated)
            if (year < 2027) {
                container.innerHTML = `<div style="text-align: center; color: #64748b; padding: 40px;">
                    <div style="font-size: 1.1rem; margin-bottom: 8px;">Policy not yet active</div>
                    <div style="font-size: 0.85rem;">The student loan threshold freeze extension takes effect from 2027. In ${year}, both scenarios are identical.</div>
                </div>`;
                return;
            }

            // Use data from backend which now tracks independent debt paths
            const FORGIVENESS_YEARS = 30;

            const baselineThreshold = row.baseline_sl_threshold;
            const reformThreshold = row.reform_sl_threshold;
            const baselineRepayment = row.baseline_sl_payment;
            const reformRepayment = row.reform_sl_payment;
            const baselineDebt = row.baseline_sl_debt;
            const reformDebt = row.reform_sl_debt;

            const forgiven = yearsFromGrad >= FORGIVENESS_YEARS;

            // Get previous year's debt for both scenarios
            const prevRow = data.find(d => d.age === selectedAge - 1);
            const prevBaselineDebt = prevRow ? prevRow.baseline_sl_debt : inputs.student_loan_debt;
            const prevReformDebt = prevRow ? prevRow.reform_sl_debt : inputs.student_loan_debt;

            // Calculate interest rate (RPI + 3%, capped at 7.1%)
            const getRpi = (y) => {
                const RPI_FORECASTS = {2024: 0.0331, 2025: 0.0416, 2026: 0.0308, 2027: 0.0300, 2028: 0.0283, 2029: 0.0283};
                const RPI_LONG_TERM = 0.0239;
                return RPI_FORECASTS[y] || RPI_LONG_TERM;
            };
            const rpi = getRpi(year);
            const interestRate = Math.min(rpi + 0.03, 0.071);

            // Combined rows with section headers
            const allRows = [
                { section: 'Policy parameters (affected by freeze)' },
                { label: 'Repayment threshold', preAB: baselineThreshold, postAB: reformThreshold },
                { section: 'Repayment calculation' },
                { label: 'Income above threshold', preAB: Math.max(0, income - baselineThreshold), postAB: Math.max(0, income - reformThreshold) },
                { label: 'Annual repayment (9%)', preAB: baselineRepayment, postAB: reformRepayment, highlight: true },
                { section: 'Debt evolution this year' },
                { label: 'Debt at start of year', preAB: prevBaselineDebt, postAB: prevReformDebt },
                { label: '− Repayment', preAB: baselineRepayment, postAB: reformRepayment },
                { label: '= After repayment', preAB: Math.max(0, prevBaselineDebt - baselineRepayment), postAB: Math.max(0, prevReformDebt - reformRepayment) },
                { label: `+ Interest (${(interestRate * 100).toFixed(1)}%)`, preAB: Math.max(0, prevBaselineDebt - baselineRepayment) * interestRate, postAB: Math.max(0, prevReformDebt - reformRepayment) * interestRate },
                { separator: true },
                { label: '= Debt at end of year', preAB: baselineDebt, postAB: reformDebt, highlight: true },
            ];

            let tableHtml = `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle} text-align: left; width: 50%;">Item</th>
                            <th style="${thStyle} width: 16.67%;">Pre-AB</th>
                            <th style="${thStyle} width: 16.67%;">Post-AB</th>
                            <th style="${thStyle} width: 16.67%;">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allRows.forEach(r => {
                if (r.section) {
                    tableHtml += `<tr><td colspan="4" style="padding: 12px 8px 6px; font-weight: 600; font-size: 0.85rem; color: #475569; background: #f8fafc;">${r.section}</td></tr>`;
                } else if (r.separator) {
                    tableHtml += `<tr><td colspan="4" style="padding: 4px;"></td></tr>`;
                } else {
                    const preABReal = toRealTerms(r.preAB, year);
                    const postABReal = toRealTerms(r.postAB, year);
                    const diff = postABReal - preABReal;
                    const rowStyle = r.highlight ? 'background: #fef2f2;' : '';
                    tableHtml += `
                        <tr style="${rowStyle}">
                            <td style="${labelStyle} ${r.highlight ? 'font-weight: 600; color: #1e293b;' : ''}">${r.label}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(preABReal)}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(postABReal)}</td>
                            <td style="${tdStyle}">${formatDiff(diff)}</td>
                        </tr>
                    `;
                }
            });

            tableHtml += `</tbody></table>`;
            tableHtml += `<div style="font-size: 0.75rem; color: #94a3b8; margin-top: 8px;">Interest = RPI (${(rpi * 100).toFixed(1)}%) + 3% = ${((rpi + 0.03) * 100).toFixed(1)}%${rpi + 0.03 > 0.071 ? ' (capped at 7.1%)' : ''}</div>`;

            const termsLabel = getTermsSuffix();
            let html = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <span style="font-weight: 600; color: #1e293b;">Year ${year}${termsLabel}</span>
                            <span style="color: #64748b; margin-left: 12px;">Gross income: £${d3.format(',.0f')(toRealTerms(income, year))}</span>
                            <span style="color: #64748b; margin-left: 12px;">Years since graduation: ${yearsFromGrad}</span>
                            ${forgiven ? '<span style="color: #22c55e; margin-left: 12px; font-weight: 500;">✓ Debt forgiven</span>' : ''}
                        </div>
                    </div>
                    ${tableHtml}

                    <div style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">
                        <strong>How it works:</strong> Repayment = 9% × (income − threshold). Pre-AB, threshold rises with RPI. Post-AB, threshold frozen at £27,295 until 2030. Higher repayments under Post-AB mean faster debt payoff but less disposable income.
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // Salary sacrifice detail chart
        function renderSalarySacrificeDetail(selectedAge, targetContainer = null) {
            const data = getDisplayData();
            if (!data.length) return;

            const row = data.find(d => d.age === selectedAge);
            const container = targetContainer || document.getElementById('salary-sacrifice-detail');
            if (!container) return;
            const deflator = getCumulativeInflation(row?.year || 2026);

            if (!row || row.gross_income === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No income at this age (retired)</div>';
                return;
            }

            const postSSIncome = row.gross_income;  // Income after salary sacrifice
            const year = row.year;
            const inputs = getInputs();
            const salarySacrifice = inputs.salary_sacrifice_per_year;
            const preSSSalary = postSSIncome + salarySacrifice;  // What they'd earn without SS

            // Tax and NI parameters
            const CAP = 2000;
            // Economy-wide: £13.8bn excess × 15% = £2.1bn employer NI, spread as 0.16% of all salaries
            // This is a tiny haircut applied to everyone's salary
            const ECONOMY_WIDE_HAIRCUT = 0.0016;  // 0.16% per research article
            const EMPLOYEE_NI_MAIN = 0.08;
            const EMPLOYEE_NI_HIGHER = 0.02;
            const NI_PT = 12570;
            const NI_UEL = 50270;
            const PA = 12570;
            const BASIC_RATE = 0.20;
            const HIGHER_RATE = 0.40;
            const BASIC_THRESHOLD = 50270;

            // Calculate NI on a given salary
            const calcNI = (salary) => {
                if (salary <= NI_PT) return 0;
                let ni = 0;
                if (salary > NI_PT) {
                    const mainBand = Math.min(salary - NI_PT, NI_UEL - NI_PT);
                    ni += mainBand * EMPLOYEE_NI_MAIN;
                }
                if (salary > NI_UEL) {
                    ni += (salary - NI_UEL) * EMPLOYEE_NI_HIGHER;
                }
                return ni;
            };

            // Calculate income tax on a given salary (after pension contributions)
            const calcIT = (salary, pensionContrib) => {
                const taxable = Math.max(0, salary - PA - pensionContrib);
                let tax = 0;
                if (taxable > 0) {
                    const basicBand = Math.min(taxable, BASIC_THRESHOLD - PA);
                    tax += basicBand * BASIC_RATE;
                }
                if (taxable > BASIC_THRESHOLD - PA) {
                    tax += (taxable - (BASIC_THRESHOLD - PA)) * HIGHER_RATE;
                }
                return tax;
            };

            // Policy takes effect from April 2029
            const policyActive = year >= 2029;

            if (!policyActive) {
                container.innerHTML = `<div style="text-align: center; color: #64748b; padding: 40px;">
                    <div style="font-size: 1.1rem; margin-bottom: 8px;">Policy not yet active</div>
                    <div style="font-size: 0.85rem;">The salary sacrifice cap takes effect from April 2029. In ${year}, both scenarios are identical.</div>
                </div>`;
                return;
            }

            const excess = Math.max(0, salarySacrifice - CAP);
            const haircutAmount = preSSSalary * ECONOMY_WIDE_HAIRCUT;

            // Pre-AB: All salary sacrifice, no taxable income from it
            const preAB_taxableIncome = postSSIncome;
            const preAB_employeePension = 0;
            const preAB_IT = calcIT(preAB_taxableIncome, preAB_employeePension);
            const preAB_NI = calcNI(preAB_taxableIncome);
            const preAB_totalPension = salarySacrifice;

            // Post-AB: Before 2029, same as Pre-AB. From 2029, excess becomes taxable + employee pension
            const postAB_ssRemaining = policyActive ? Math.min(salarySacrifice, CAP) : salarySacrifice;
            const postAB_adjustedSalary = preSSSalary - haircutAmount;
            const postAB_taxableIncome = postAB_adjustedSalary - postAB_ssRemaining;
            const postAB_employeePension = excess;  // Full excess redirected to employee pension
            const postAB_IT = calcIT(postAB_taxableIncome, postAB_employeePension);
            const postAB_NI = calcNI(postAB_taxableIncome);
            const postAB_totalPension = postAB_ssRemaining + postAB_employeePension;

            // Calculate net impact
            const preAB_takeHome = preSSSalary - preAB_IT - preAB_NI - salarySacrifice;
            const postAB_takeHome = postAB_adjustedSalary - postAB_IT - postAB_NI - postAB_totalPension;

            // Combined rows with section headers
            const allRows = [
                { section: 'Income breakdown' },
                { label: 'Salary (before any pension)', preAB: preSSSalary, postAB: preSSSalary, noFormat: true },
                { label: '− Employer NI haircut (0.16%)', preAB: 0, postAB: haircutAmount },
                { label: '− Salary sacrifice (employer pension)', preAB: salarySacrifice, postAB: postAB_ssRemaining },
                { separator: true },
                { label: '= Taxable employment income', preAB: preAB_taxableIncome, postAB: postAB_taxableIncome },
                { section: 'Pension contributions' },
                { label: 'Employer pension (salary sacrifice)', preAB: salarySacrifice, postAB: postAB_ssRemaining },
                { label: 'Employee pension contribution', preAB: 0, postAB: postAB_employeePension },
                { separator: true },
                { label: '= Total pension contribution', preAB: preAB_totalPension, postAB: postAB_totalPension, noFormat: true },
                { section: 'Tax & NI' },
                { label: 'Income tax (after pension relief)', preAB: preAB_IT, postAB: postAB_IT },
                { label: 'Employee NI', preAB: preAB_NI, postAB: postAB_NI, highlight: true },
                { section: 'Summary' },
                { label: 'Take-home pay', preAB: preAB_takeHome, postAB: postAB_takeHome, highlight: true },
                { label: 'Total pension contribution', preAB: preAB_totalPension, postAB: postAB_totalPension },
            ];

            let tableHtml = `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle} text-align: left; width: 50%;">Item</th>
                            <th style="${thStyle} width: 16.67%;">Pre-AB</th>
                            <th style="${thStyle} width: 16.67%;">Post-AB</th>
                            <th style="${thStyle} width: 16.67%;">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allRows.forEach(r => {
                if (r.section) {
                    tableHtml += `<tr><td colspan="4" style="padding: 12px 8px 6px; font-weight: 600; font-size: 0.85rem; color: #475569; background: #f8fafc;">${r.section}</td></tr>`;
                } else if (r.separator) {
                    tableHtml += `<tr><td colspan="4" style="padding: 4px;"></td></tr>`;
                } else {
                    const preABReal = toRealTerms(r.preAB, year);
                    const postABReal = toRealTerms(r.postAB, year);
                    const diff = postABReal - preABReal;
                    const rowStyle = r.highlight ? 'background: #fef2f2;' : '';
                    tableHtml += `
                        <tr style="${rowStyle}">
                            <td style="${labelStyle} ${r.highlight ? 'font-weight: 600; color: #1e293b;' : ''}">${r.label}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(preABReal)}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(postABReal)}</td>
                            <td style="${tdStyle}">${r.noFormat ? '' : formatDiff(diff)}</td>
                        </tr>
                    `;
                }
            });

            tableHtml += `</tbody></table>`;

            const termsLabel = getTermsSuffix();
            let html = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <span style="font-weight: 600; color: #1e293b;">Year ${year}${termsLabel}</span>
                            <span style="color: #64748b; margin-left: 12px;">Pre-SS salary: £${d3.format(',.0f')(toRealTerms(preSSSalary, year))}</span>
                            <span style="color: #64748b; margin-left: 12px;">Pension contribution: £${d3.format(',.0f')(toRealTerms(salarySacrifice, year))}/yr</span>
                        </div>
                    </div>

                    ${tableHtml}

                    <div style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">
                        <strong>How it works:</strong> Pre-AB, all pension via salary sacrifice avoids income tax and NI. Post-AB (from April 2029), only the first £2,000 can use salary sacrifice. Excess above £2,000 becomes taxable employment income and employee pension contribution. You still get income tax relief on the employee contribution, but employee NI is now charged. Employers spread their new NI costs (£2.1bn economy-wide) across all workers as a 0.16% salary reduction.
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // Rail fare detail chart
        function renderRailFareDetail(selectedAge, targetContainer = null) {
            const data = getDisplayData();
            if (!data.length) return;

            const row = data.find(d => d.age === selectedAge);
            const container = targetContainer || document.getElementById('rail-fare-detail');
            if (!container) return;

            if (!row || row.gross_income === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No income at this age (retired)</div>';
                return;
            }

            const year = row.year;
            const railSpendingBase = parseFloat(document.getElementById('rail_spending_per_year').value);
            const baseYear = 2024;

            // Policy takes effect from 2026
            if (year < 2026) {
                container.innerHTML = `<div style="text-align: center; color: #64748b; padding: 40px;">
                    <div style="font-size: 1.1rem; margin-bottom: 8px;">Policy not yet active</div>
                    <div style="font-size: 0.85rem;">The rail fare freeze takes effect from 2026. In ${year}, there is no impact.</div>
                </div>`;
                return;
            }

            // Rail fares increase by RPI + 1% annually
            const RAIL_MARKUP = 0.01;
            const RPI_FORECASTS = {2024: 0.0331, 2025: 0.0416, 2026: 0.0308, 2027: 0.0300, 2028: 0.0283, 2029: 0.0283};
            const RPI_LONG_TERM = 0.0239;
            const getRpi = (y) => RPI_FORECASTS[y] || RPI_LONG_TERM;

            // Calculate fare index from base year
            function getFareIndex(targetYear, freeze2026) {
                let index = 1.0;
                for (let y = baseYear; y < targetYear; y++) {
                    if (freeze2026 && y === 2025) continue; // 2026 freeze = skip 2025's increase
                    const rpi = getRpi(y);
                    index *= (1 + rpi + RAIL_MARKUP);
                }
                return index;
            }

            const preAB_index = getFareIndex(year, false);
            const postAB_index = getFareIndex(year, true);
            const preAB_spending = railSpendingBase * preAB_index;
            const postAB_spending = railSpendingBase * postAB_index;
            const savings = preAB_spending - postAB_spending;

            const impact = row.impact_rail_fare_freeze;
            const termsLabel = getTermsSuffix();

            // Combined rows with section headers
            const allRows = [
                { section: 'Fare index calculation' },
                { label: 'Your rail spending (2024)', preAB: railSpendingBase, postAB: railSpendingBase },
                { label: 'Fare index (from 2024)', preAB: `${preAB_index.toFixed(3)}×`, postAB: `${postAB_index.toFixed(3)}×`, isText: true },
                { section: 'Current year spending' },
                { label: `Rail spending (${year})`, preAB: preAB_spending, postAB: postAB_spending },
                { separator: true },
                { label: 'Annual saving from freeze', preAB: 0, postAB: savings, highlight: true },
            ];

            let tableHtml = `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle} text-align: left; width: 50%;">Item</th>
                            <th style="${thStyle} width: 16.67%;">Pre-AB</th>
                            <th style="${thStyle} width: 16.67%;">Post-AB</th>
                            <th style="${thStyle} width: 16.67%;">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allRows.forEach(r => {
                if (r.section) {
                    tableHtml += `<tr><td colspan="4" style="padding: 12px 8px 6px; font-weight: 600; font-size: 0.85rem; color: #475569; background: #f8fafc;">${r.section}</td></tr>`;
                } else if (r.separator) {
                    tableHtml += `<tr><td colspan="4" style="padding: 4px;"></td></tr>`;
                } else if (r.isText) {
                    tableHtml += `
                        <tr>
                            <td style="${labelStyle}">${r.label}</td>
                            <td style="${tdStyle}">${r.preAB}</td>
                            <td style="${tdStyle}">${r.postAB}</td>
                            <td style="${tdStyle}">-</td>
                        </tr>
                    `;
                } else {
                    const preABReal = toRealTerms(r.preAB, year);
                    const postABReal = toRealTerms(r.postAB, year);
                    const diff = postABReal - preABReal;
                    const rowStyle = r.highlight ? 'background: #e0f2fe;' : '';
                    tableHtml += `
                        <tr style="${rowStyle}">
                            <td style="${labelStyle} ${r.highlight ? 'font-weight: 600; color: #1e293b;' : ''}">${r.label}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(preABReal)}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(postABReal)}</td>
                            <td style="${tdStyle}">${formatDiff(diff)}</td>
                        </tr>
                    `;
                }
            });

            tableHtml += `</tbody></table>`;

            const html = `
                <div style="font-size: 0.95rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: #334155;">Rail fare freeze${termsLabel}</div>
                            <div style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">One-year freeze on rail fares in 2026</div>
                        </div>
                    </div>

                    ${tableHtml}

                    <div style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">
                        <strong>How it works:</strong> Rail fares normally rise by RPI + 1% annually. In 2026, the government froze fares at 2025 levels. After 2026, fares resume rising but from the lower frozen base, so the savings persist permanently.
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // Fuel duty detail chart
        function renderFuelDutyDetail(selectedAge, targetContainer = null) {
            const data = getDisplayData();
            if (!data.length) return;

            const row = data.find(d => d.age === selectedAge);
            const container = targetContainer || document.getElementById('fuel-duty-detail');
            if (!container) return;
            const deflator = getCumulativeInflation(row?.year || 2026);

            if (!row || row.gross_income === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No income at this age (retired)</div>';
                return;
            }

            const year = row.year;
            const petrolSpending = parseFloat(document.getElementById('petrol_spending_per_year').value);

            // Policy takes effect from 2026
            if (year < 2026) {
                container.innerHTML = `<div style="text-align: center; color: #64748b; padding: 40px;">
                    <div style="font-size: 1.1rem; margin-bottom: 8px;">Policy not yet active</div>
                    <div style="font-size: 0.85rem;">Fuel duty changes take effect from 2026. In ${year}, there is no impact.</div>
                </div>`;
                return;
            }

            // Fuel duty rates (pence per litre)
            const UNFROZEN_RATE = 58.0;  // Counterfactual: what it would be if not frozen
            const AVG_PRICE = 140;  // pence per litre

            let reformRate, rateDescription;
            if (year === 2026) {
                // FY 2026-27: phased increases - weighted average
                reformRate = 54.37;  // (5*52.95 + 3*53.95 + 3*55.95 + 1*57.95) / 12
                rateDescription = '5p cut extended to Aug, then phased increases (+1p Sep, +2p Dec, +2p Mar)';
            } else {
                // FY 2027-28 onwards: full rate of 57.95p
                reformRate = 57.95;
                rateDescription = 'Full rate after phased increases complete';
            }

            // Litres purchased and duty amounts
            const litres = petrolSpending / (AVG_PRICE / 100);
            const dutyUnfrozen = litres * (UNFROZEN_RATE / 100);
            const dutyReform = litres * (reformRate / 100);
            const saving = dutyUnfrozen - dutyReform;

            const impact = row.impact_fuel_duty_freeze;

            // Combined rows with section headers
            const allRows = [
                { section: 'Fuel consumption' },
                { label: 'Your annual petrol spending', preAB: petrolSpending, postAB: petrolSpending },
                { label: 'Estimated litres purchased', preAB: litres.toFixed(0), postAB: litres.toFixed(0), isText: true },
                { section: 'Fuel duty rates' },
                { label: 'Fuel duty rate (p/litre)', preAB: UNFROZEN_RATE.toFixed(2) + 'p', postAB: reformRate.toFixed(2) + 'p', isText: true },
                { label: 'Total duty paid', preAB: dutyUnfrozen, postAB: dutyReform },
                { section: 'Summary' },
                { label: 'Annual saving from lower duty', preAB: 0, postAB: impact, highlight: true },
            ];

            let tableHtml = `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle} text-align: left; width: 50%;">Item</th>
                            <th style="${thStyle} width: 16.67%;">Pre-AB</th>
                            <th style="${thStyle} width: 16.67%;">Post-AB</th>
                            <th style="${thStyle} width: 16.67%;">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allRows.forEach(r => {
                if (r.section) {
                    tableHtml += `<tr><td colspan="4" style="padding: 12px 8px 6px; font-weight: 600; font-size: 0.85rem; color: #475569; background: #f8fafc;">${r.section}</td></tr>`;
                } else if (r.separator) {
                    tableHtml += `<tr><td colspan="4" style="padding: 4px;"></td></tr>`;
                } else if (r.isText) {
                    tableHtml += `
                        <tr>
                            <td style="${labelStyle}">${r.label}</td>
                            <td style="${tdStyle}">${r.preAB}</td>
                            <td style="${tdStyle}">${r.postAB}</td>
                            <td style="${tdStyle}">-</td>
                        </tr>
                    `;
                } else {
                    const preABReal = toRealTerms(r.preAB, year);
                    const postABReal = toRealTerms(r.postAB, year);
                    const diff = postABReal - preABReal;
                    const rowStyle = r.highlight ? 'background: #e0f2fe;' : '';
                    tableHtml += `
                        <tr style="${rowStyle}">
                            <td style="${labelStyle} ${r.highlight ? 'font-weight: 600; color: #1e293b;' : ''}">${r.label}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(preABReal)}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(postABReal)}</td>
                            <td style="${tdStyle}">${formatDiff(diff)}</td>
                        </tr>
                    `;
                }
            });

            tableHtml += `</tbody></table>`;

            const termsLabel = getTermsSuffix();
            const html = `
                <div style="font-size: 0.95rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: #334155;">Fuel duty reform${termsLabel}</div>
                            <div style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">${rateDescription}</div>
                        </div>
                    </div>

                    ${tableHtml}

                    <div style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">
                        <strong>How it works:</strong> The government extended the 5p fuel duty cut to August 2026, then phased in increases. Compared to an unfrozen baseline of 58p/litre, this results in lower duty payments. The saving depends on how much you drive.
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // Unearned income tax detail chart
        function renderUnearnedIncomeDetail(selectedAge) {
            const data = getDisplayData();
            if (!data.length) return;

            const row = data.find(d => d.age === selectedAge);
            const container = document.getElementById('unearned-income-detail');
            const deflator = getCumulativeInflation(row?.year || 2026);

            if (!row || row.gross_income === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No income at this age (retired)</div>';
                return;
            }

            const year = row.year;
            const dividends = parseFloat(document.getElementById('dividends_per_year').value);
            const savingsInterest = parseFloat(document.getElementById('savings_interest_per_year').value);
            const propertyIncome = parseFloat(document.getElementById('property_income_per_year').value);
            const grossIncome = row.gross_income;

            // Personal allowance from API - different for baseline vs reform due to threshold freeze
            const baselinePA = row.baseline_pa;
            const reformPA = row.reform_pa;
            const baselineBasicThreshold = row.baseline_basic_threshold;
            const reformBasicThreshold = row.reform_basic_threshold;

            const totalUnearned = dividends + savingsInterest + propertyIncome;

            // Helper function to calculate unearned income tax
            function calcUnearnedTax(pa, basicThreshold, applyRateIncrease = false) {
                const remainingPA = Math.max(0, pa - grossIncome);
                const totalIncome = grossIncome + totalUnearned;
                const isHigherRate = totalIncome > basicThreshold;

                const DIVIDEND_ALLOWANCE = 500;
                const SAVINGS_ALLOWANCE = isHigherRate ? 500 : 1000;

                const dividendRate = isHigherRate ? 0.3375 : 0.0875;
                const savingsRate = isHigherRate ? 0.40 : 0.20;
                const propertyRate = isHigherRate ? 0.40 : 0.20;

                // Apply rate increase for post-AB
                const rateMultiplier = applyRateIncrease ? 1.05 : 1.0;

                let paUsed = 0;

                // Savings interest (uses PA first)
                const savingsAfterPA = Math.max(0, savingsInterest - Math.max(0, remainingPA - paUsed));
                paUsed += Math.min(savingsInterest, Math.max(0, remainingPA - paUsed));
                const taxableSavings = Math.max(0, savingsAfterPA - SAVINGS_ALLOWANCE);

                // Dividends (uses remaining PA)
                const dividendsAfterPA = Math.max(0, dividends - Math.max(0, remainingPA - paUsed));
                paUsed += Math.min(dividends, Math.max(0, remainingPA - paUsed));
                const taxableDividends = Math.max(0, dividendsAfterPA - DIVIDEND_ALLOWANCE);

                // Property income (uses any remaining PA)
                const propertyAfterPA = Math.max(0, propertyIncome - Math.max(0, remainingPA - paUsed));
                const taxableProperty = propertyAfterPA;

                return {
                    remainingPA,
                    isHigherRate,
                    taxableSavings,
                    taxableDividends,
                    taxableProperty,
                    savingsTax: taxableSavings * savingsRate * rateMultiplier,
                    dividendTax: taxableDividends * dividendRate * rateMultiplier,
                    propertyTax: taxableProperty * propertyRate * rateMultiplier,
                    totalTax: (taxableSavings * savingsRate + taxableDividends * dividendRate + taxableProperty * propertyRate) * rateMultiplier,
                    dividendRate,
                    savingsRate,
                    propertyRate,
                    SAVINGS_ALLOWANCE,
                    DIVIDEND_ALLOWANCE
                };
            }

            const preAB = calcUnearnedTax(baselinePA, baselineBasicThreshold, false);
            const postAB = calcUnearnedTax(reformPA, reformBasicThreshold, true);

            const impact = row.impact_unearned_income_tax;

            const allRows = [
                { section: 'Your income' },
                { label: 'Earned income (employment/pension)', preAB: grossIncome, postAB: grossIncome },
                { label: 'Personal allowance', preAB: baselinePA, postAB: reformPA },
                { label: 'Remaining PA for unearned income', preAB: preAB.remainingPA, postAB: postAB.remainingPA },
                { section: 'Unearned income' },
                { label: 'Savings interest', preAB: savingsInterest, postAB: savingsInterest },
                { label: 'Dividend income', preAB: dividends, postAB: dividends },
                { label: 'Property income', preAB: propertyIncome, postAB: propertyIncome },
                { label: 'Total unearned', preAB: totalUnearned, postAB: totalUnearned },
                { section: 'Taxable amounts (after PA & allowances)' },
                { label: 'Taxable savings (after PA & £' + preAB.SAVINGS_ALLOWANCE + ' allowance)', preAB: preAB.taxableSavings, postAB: postAB.taxableSavings },
                { label: 'Taxable dividends (after PA & £' + preAB.DIVIDEND_ALLOWANCE + ' allowance)', preAB: preAB.taxableDividends, postAB: postAB.taxableDividends },
                { label: 'Taxable property (after PA)', preAB: preAB.taxableProperty, postAB: postAB.taxableProperty },
                { section: 'Tax calculation' },
                { label: 'Rate band', preAB: preAB.isHigherRate ? 'Higher rate' : 'Basic rate', postAB: postAB.isHigherRate ? 'Higher rate' : 'Basic rate', isText: true },
                { label: 'Tax on savings (' + (preAB.savingsRate * 100) + '% → ' + (postAB.savingsRate * 100 * 1.05).toFixed(1) + '%)', preAB: preAB.savingsTax, postAB: postAB.savingsTax },
                { label: 'Tax on dividends (' + (preAB.dividendRate * 100).toFixed(2) + '% → ' + (postAB.dividendRate * 100 * 1.05).toFixed(2) + '%)', preAB: preAB.dividendTax, postAB: postAB.dividendTax },
                { label: 'Tax on property (' + (preAB.propertyRate * 100) + '% → ' + (postAB.propertyRate * 100 * 1.05).toFixed(1) + '%)', preAB: preAB.propertyTax, postAB: postAB.propertyTax },
                { separator: true },
                { label: 'Total unearned income tax', preAB: preAB.totalTax, postAB: postAB.totalTax, highlight: true },
            ];

            const termsSuffix = getTermsSuffix();
            let tableHtml = `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle} text-align: left; width: 50%;">Item</th>
                            <th style="${thStyle} width: 16.67%;">Pre-AB${termsSuffix}</th>
                            <th style="${thStyle} width: 16.67%;">Post-AB${termsSuffix}</th>
                            <th style="${thStyle} width: 16.67%;">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allRows.forEach(r => {
                if (r.section) {
                    tableHtml += `<tr><td colspan="4" style="padding: 12px 8px 6px; font-weight: 600; font-size: 0.85rem; color: #475569; background: #f8fafc;">${r.section}</td></tr>`;
                } else if (r.separator) {
                    tableHtml += `<tr><td colspan="4" style="padding: 4px;"></td></tr>`;
                } else if (r.isText) {
                    tableHtml += `
                        <tr>
                            <td style="${labelStyle}">${r.label}</td>
                            <td style="${tdStyle}">${r.preAB}</td>
                            <td style="${tdStyle}">${r.postAB}</td>
                            <td style="${tdStyle}">-</td>
                        </tr>
                    `;
                } else {
                    const preABReal = toRealTerms(r.preAB, year);
                    const postABReal = toRealTerms(r.postAB, year);
                    const diff = postABReal - preABReal;
                    const rowStyle = r.highlight ? 'background: #fef2f2;' : '';
                    tableHtml += `
                        <tr style="${rowStyle}">
                            <td style="${labelStyle} ${r.highlight ? 'font-weight: 600; color: #1e293b;' : ''}">${r.label}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(preABReal)}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(postABReal)}</td>
                            <td style="${tdStyle}">${formatDiff(diff)}</td>
                        </tr>
                    `;
                }
            });

            tableHtml += `</tbody></table>`;

            const html = `
                <div style="font-size: 0.95rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: #334155;">Unearned income tax</div>
                            <div style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">5% increase in tax on dividends, savings, and property income</div>
                        </div>
                    </div>

                    ${tableHtml}

                    <div style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">
                        <strong>How it works:</strong> The Autumn Budget increased taxes on unearned income by 5% and froze the personal allowance. Pre-AB, the PA would be £${d3.format(',.0f')(baselinePA)}; post-AB it's frozen at £${d3.format(',.0f')(reformPA)}. Your PA is first used by earned income; any remainder shelters unearned income. ${postAB.remainingPA > 0 ? `With £${d3.format(',.0f')(grossIncome)} earned income, you have £${d3.format(',.0f')(postAB.remainingPA)} PA remaining (vs £${d3.format(',.0f')(preAB.remainingPA)} pre-AB).` : 'Your earned income uses all your PA, so all unearned income is taxable.'} After PA, savings and dividend allowances (£${preAB.SAVINGS_ALLOWANCE}/£${preAB.DIVIDEND_ALLOWANCE}) further reduce taxable amounts.
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        const tooltip = d3.select('#tooltip');

        // Modal
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        const modalPrev = document.getElementById('modal-prev');
        const modalNext = document.getElementById('modal-next');

        let modalActiveTab = 'summary';
        let currentModalAge = null;

        modalClose.addEventListener('click', () => modalOverlay.classList.remove('active'));
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) modalOverlay.classList.remove('active');
        });

        // Navigation button handlers
        modalPrev.addEventListener('click', () => {
            if (currentModalAge === null || !currentData.length) return;
            const ages = currentData.map(d => d.age).sort((a, b) => a - b);
            const currentIndex = ages.indexOf(currentModalAge);
            if (currentIndex > 0) {
                showModal(ages[currentIndex - 1], modalActiveTab);
            }
        });

        modalNext.addEventListener('click', () => {
            if (currentModalAge === null || !currentData.length) return;
            const ages = currentData.map(d => d.age).sort((a, b) => a - b);
            const currentIndex = ages.indexOf(currentModalAge);
            if (currentIndex < ages.length - 1) {
                showModal(ages[currentIndex + 1], modalActiveTab);
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!modalOverlay.classList.contains('active')) return;
            if (e.key === 'ArrowLeft') modalPrev.click();
            else if (e.key === 'ArrowRight') modalNext.click();
            else if (e.key === 'Escape') modalOverlay.classList.remove('active');
        });

        function showModal(age, initialTab = null) {
            const row = currentData.find(d => d.age === age);
            if (!row) return;

            currentModalAge = age;

            // Set the active tab based on initialTab parameter
            if (initialTab) {
                modalActiveTab = initialTab;
            }

            const year = row.year;
            const gross = row.gross_income;
            const slDebt = row.student_loan_debt_remaining;

            modalTitle.textContent = `Age ${age} (${year})`;

            // Update nav button states
            const ages = currentData.map(d => d.age).sort((a, b) => a - b);
            const currentIndex = ages.indexOf(age);
            modalPrev.disabled = currentIndex <= 0;
            modalNext.disabled = currentIndex >= ages.length - 1;

            // Build summary section
            let summaryHtml = `
                <div class="calc-section">
                    <div class="calc-title">Income & deductions</div>
                    <table class="calc-table">
                        <tr><td>Gross income</td><td>£${d3.format(',.0f')(gross)}</td></tr>
                        <tr><td>Income tax</td><td>£${d3.format(',.0f')(row.income_tax)}</td></tr>
                        <tr><td>National insurance</td><td>£${d3.format(',.0f')(row.national_insurance)}</td></tr>
                        <tr><td>Student loan payment</td><td>£${d3.format(',.0f')(row.student_loan_payment)}</td></tr>
                        <tr><td>Student loan debt remaining</td><td>£${d3.format(',.0f')(slDebt)}</td></tr>
                    </table>
                </div>
            `;

            reforms.forEach(r => {
                const impact = row[r.key];
                summaryHtml += `
                    <div class="calc-section">
                        <div class="calc-title"><span class="calc-dot" style="background:${r.color}"></span>${r.label}</div>
                        <table class="calc-table">
                            <tr><td>Year</td><td>${year}</td></tr>
                            <tr class="calc-result ${impact >= 0 ? 'positive' : 'negative'}"><td>Impact</td><td>${formatSignedCurrency(impact)}</td></tr>
                        </table>
                    </div>
                `;
            });

            const netImpact = reforms.reduce((sum, r) => sum + row[r.key], 0);
            summaryHtml += `
                <div class="calc-section">
                    <div class="calc-title">Net impact at age ${age}</div>
                    <table class="calc-table">
                        <tr class="calc-result ${netImpact >= 0 ? 'positive' : 'negative'}"><td>Total</td><td>${formatSignedCurrency(netImpact)}</td></tr>
                    </table>
                </div>
            `;

            // Build modal with tabs
            const html = `
                <div class="tab-bar" style="margin: -24px -24px 24px -24px; padding: 0 24px; border-bottom: 1px solid #e2e8f0;">
                    <button class="detail-tab modal-tab ${modalActiveTab === 'summary' ? 'active' : ''}" data-modal-tab="summary">Summary</button>
                    <button class="detail-tab modal-tab ${modalActiveTab === 'tax' ? 'active' : ''}" data-modal-tab="tax">Threshold freeze</button>
                    <button class="detail-tab modal-tab ${modalActiveTab === 'student-loan' ? 'active' : ''}" data-modal-tab="student-loan">Student loan</button>
                    <button class="detail-tab modal-tab ${modalActiveTab === 'salary-sacrifice' ? 'active' : ''}" data-modal-tab="salary-sacrifice">Salary sacrifice</button>
                    <button class="detail-tab modal-tab ${modalActiveTab === 'rail-fare' ? 'active' : ''}" data-modal-tab="rail-fare">Rail fare</button>
                    <button class="detail-tab modal-tab ${modalActiveTab === 'fuel-duty' ? 'active' : ''}" data-modal-tab="fuel-duty">Fuel duty</button>
                    <button class="detail-tab modal-tab ${modalActiveTab === 'unearned-income' ? 'active' : ''}" data-modal-tab="unearned-income">Unearned income</button>
                </div>
                <div id="modal-summary-panel" class="modal-panel" style="${modalActiveTab === 'summary' ? '' : 'display: none;'}">${summaryHtml}</div>
                <div id="modal-tax-panel" class="modal-panel" style="${modalActiveTab === 'tax' ? '' : 'display: none;'}"></div>
                <div id="modal-student-loan-panel" class="modal-panel" style="${modalActiveTab === 'student-loan' ? '' : 'display: none;'}"></div>
                <div id="modal-salary-sacrifice-panel" class="modal-panel" style="${modalActiveTab === 'salary-sacrifice' ? '' : 'display: none;'}"></div>
                <div id="modal-rail-fare-panel" class="modal-panel" style="${modalActiveTab === 'rail-fare' ? '' : 'display: none;'}"></div>
                <div id="modal-fuel-duty-panel" class="modal-panel" style="${modalActiveTab === 'fuel-duty' ? '' : 'display: none;'}"></div>
                <div id="modal-unearned-income-panel" class="modal-panel" style="${modalActiveTab === 'unearned-income' ? '' : 'display: none;'}"></div>
            `;

            modalBody.innerHTML = html;
            modalOverlay.classList.add('active');

            // Set up modal tab switching
            modalBody.querySelectorAll('.modal-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    modalBody.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    modalActiveTab = tab.dataset.modalTab;

                    modalBody.querySelectorAll('.modal-panel').forEach(p => p.style.display = 'none');
                    const panelId = 'modal-' + modalActiveTab + '-panel';
                    document.getElementById(panelId).style.display = 'block';

                    // Render the selected tab content
                    renderModalTab(age, modalActiveTab);
                });
            });

            // Render the active tab content
            renderModalTab(age, modalActiveTab);
        }

        function renderModalTab(age, tabName) {
            if (tabName === 'summary') return; // Summary is already rendered

            const data = getDisplayData();
            if (!data.length) return;

            const row = data.find(d => d.age === age);
            if (!row) return;

            const panelId = 'modal-' + tabName + '-panel';
            const container = document.getElementById(panelId);
            if (!container) return;

            // Render the appropriate content based on the tab
            switch (tabName) {
                case 'tax':
                    renderTaxDetailChartToContainer(age, container);
                    break;
                case 'student-loan':
                    renderStudentLoanDetailToContainer(age, container);
                    break;
                case 'salary-sacrifice':
                    renderSalarySacrificeDetailToContainer(age, container);
                    break;
                case 'rail-fare':
                    renderRailFareDetailToContainer(age, container);
                    break;
                case 'fuel-duty':
                    renderFuelDutyDetailToContainer(age, container);
                    break;
                case 'unearned-income':
                    renderUnearnedIncomeDetailToContainer(age, container);
                    break;
            }
        }

        // Container-based render functions for modal
        function renderTaxDetailChartToContainer(selectedAge, container) {
            // Use currentData (nominal values) for consistent tax calculations
            // Then apply toRealTerms() only for display purposes
            if (!currentData.length) return;

            const row = currentData.find(d => d.age === selectedAge);
            if (!row || row.gross_income === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No income at this age (retired)</div>';
                return;
            }

            const income = row.gross_income;
            const year = row.year;

            if (year < 2028) {
                container.innerHTML = `<div style="text-align: center; color: #64748b; padding: 40px;">
                    <div style="font-size: 1.1rem; margin-bottom: 8px;">Policy not yet active</div>
                    <div style="font-size: 0.85rem;">The threshold freeze extension takes effect from 2028 when the original freeze was due to end. In ${year}, both scenarios are identical.</div>
                </div>`;
                return;
            }

            const calcEffectivePA = (pa, taperThreshold) => {
                if (income > taperThreshold) {
                    const reduction = Math.min(pa, (income - taperThreshold) * 0.5);
                    return Math.max(0, pa - reduction);
                }
                return pa;
            };

            const baselineEffectivePA = calcEffectivePA(row.baseline_pa, row.baseline_taper_threshold);
            const reformEffectivePA = calcEffectivePA(row.reform_pa, row.reform_taper_threshold);

            const calcBands = (effectivePA, basicThreshold, additionalThreshold) => {
                let remaining = income;
                const taxFree = Math.min(remaining, effectivePA);
                remaining -= taxFree;
                const basicBand = Math.max(0, Math.min(remaining, basicThreshold - effectivePA));
                remaining -= basicBand;
                const higherBand = Math.max(0, Math.min(remaining, additionalThreshold - basicThreshold));
                remaining -= higherBand;
                const additionalBand = Math.max(0, remaining);
                const tax = basicBand * 0.20 + higherBand * 0.40 + additionalBand * 0.45;
                return { taxFree, basicBand, higherBand, additionalBand, tax };
            };

            const baselineBands = calcBands(baselineEffectivePA, row.baseline_basic_threshold, row.baseline_additional_threshold);
            const reformBands = calcBands(reformEffectivePA, row.reform_basic_threshold, row.reform_additional_threshold);

            const allRows = [
                { section: 'Policy parameters (affected by freeze)' },
                { label: 'Personal allowance', preAB: row.baseline_pa, postAB: row.reform_pa },
                { label: 'Basic rate threshold', preAB: row.baseline_basic_threshold, postAB: row.reform_basic_threshold },
                { label: 'Additional rate threshold', preAB: row.baseline_additional_threshold, postAB: row.reform_additional_threshold },
                { section: 'Tax calculation' },
                { label: 'Effective personal allowance', preAB: baselineEffectivePA, postAB: reformEffectivePA, note: income > row.baseline_taper_threshold ? `(PA − 50% of income over £100k)` : '' },
                { label: 'Income taxed at 0%', preAB: baselineBands.taxFree, postAB: reformBands.taxFree },
                { label: 'Income taxed at 20%', preAB: baselineBands.basicBand, postAB: reformBands.basicBand },
                { label: 'Income taxed at 40%', preAB: baselineBands.higherBand, postAB: reformBands.higherBand },
                { label: 'Income taxed at 45%', preAB: baselineBands.additionalBand, postAB: reformBands.additionalBand },
                { separator: true },
                { label: 'Total income tax', preAB: baselineBands.tax, postAB: reformBands.tax, highlight: true },
            ];

            const termsSuffix = getTermsSuffix();
            let tableHtml = `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle} text-align: left; width: 50%;">Item</th>
                            <th style="${thStyle} width: 16.67%;">Pre-AB${termsSuffix}</th>
                            <th style="${thStyle} width: 16.67%;">Post-AB${termsSuffix}</th>
                            <th style="${thStyle} width: 16.67%;">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allRows.forEach(r => {
                if (r.section) {
                    tableHtml += `<tr><td colspan="4" style="padding: 12px 8px 6px; font-weight: 600; font-size: 0.85rem; color: #475569; background: #f8fafc;">${r.section}</td></tr>`;
                } else if (r.separator) {
                    tableHtml += `<tr><td colspan="4" style="padding: 4px;"></td></tr>`;
                } else {
                    const preABReal = toRealTerms(r.preAB, year);
                    const postABReal = toRealTerms(r.postAB, year);
                    const diff = postABReal - preABReal;
                    const rowStyle = r.highlight ? 'background: #fef2f2;' : '';
                    tableHtml += `
                        <tr style="${rowStyle}">
                            <td style="${labelStyle} ${r.highlight ? 'font-weight: 600; color: #1e293b;' : ''}">${r.label}${r.note ? `<br><span style="font-size: 0.75rem; color: #94a3b8;">${r.note}</span>` : ''}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(preABReal)}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(postABReal)}</td>
                            <td style="${tdStyle}">${formatDiff(diff)}</td>
                        </tr>
                    `;
                }
            });

            tableHtml += `</tbody></table>`;

            container.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <span style="font-weight: 600; color: #1e293b;">Year ${year}${termsSuffix}</span>
                            <span style="color: #64748b; margin-left: 12px;">Gross income: £${d3.format(',.0f')(toRealTerms(income, year))}</span>
                        </div>
                    </div>
                    ${tableHtml}
                    <div style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">
                        <strong>How it works:</strong> Pre-AB, PA/basic/additional thresholds would rise with CPI from 2028. Post-AB, they remain frozen until 2030-31, then rise with CPI. The PA taper threshold (£100k) is never uprated - it's been fixed since 2009.
                    </div>
                </div>
            `;
        }

        function renderStudentLoanDetailToContainer(selectedAge, container) {
            renderStudentLoanDetail(selectedAge, container);
        }

        function renderSalarySacrificeDetailToContainer(selectedAge, container) {
            renderSalarySacrificeDetail(selectedAge, container);
        }

        function renderRailFareDetailToContainer(selectedAge, container) {
            renderRailFareDetail(selectedAge, container);
        }

        function renderFuelDutyDetailToContainer(selectedAge, container) {
            renderFuelDutyDetail(selectedAge, container);
        }

        function renderUnearnedIncomeDetailToContainer(selectedAge, container) {
            const data = getDisplayData();
            if (!data.length) return;

            const row = data.find(d => d.age === selectedAge);
            if (!row || row.gross_income === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No income at this age (retired)</div>';
                return;
            }

            const year = row.year;
            const dividends = parseFloat(document.getElementById('dividends_per_year').value);
            const savingsInterest = parseFloat(document.getElementById('savings_interest_per_year').value);
            const propertyIncome = parseFloat(document.getElementById('property_income_per_year').value);
            const grossIncome = row.gross_income;

            const baselinePA = row.baseline_pa;
            const reformPA = row.reform_pa;
            const baselineBasicThreshold = row.baseline_basic_threshold;
            const reformBasicThreshold = row.reform_basic_threshold;

            const totalUnearned = dividends + savingsInterest + propertyIncome;

            if (totalUnearned === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No unearned income - set dividends, savings interest, or property income above to see impact</div>';
                return;
            }

            function calcUnearnedTax(pa, basicThreshold, applyRateIncrease = false) {
                const remainingPA = Math.max(0, pa - grossIncome);
                const totalIncome = grossIncome + totalUnearned;
                const isHigherRate = totalIncome > basicThreshold;

                const DIVIDEND_ALLOWANCE = 500;
                const SAVINGS_ALLOWANCE = isHigherRate ? 500 : 1000;

                const dividendRate = isHigherRate ? 0.3375 : 0.0875;
                const savingsRate = isHigherRate ? 0.40 : 0.20;
                const propertyRate = isHigherRate ? 0.40 : 0.20;

                const rateMultiplier = applyRateIncrease ? 1.05 : 1.0;

                let paUsed = 0;
                const savingsAfterPA = Math.max(0, savingsInterest - Math.max(0, remainingPA - paUsed));
                paUsed += Math.min(savingsInterest, Math.max(0, remainingPA - paUsed));
                const taxableSavings = Math.max(0, savingsAfterPA - SAVINGS_ALLOWANCE);

                const dividendsAfterPA = Math.max(0, dividends - Math.max(0, remainingPA - paUsed));
                paUsed += Math.min(dividends, Math.max(0, remainingPA - paUsed));
                const taxableDividends = Math.max(0, dividendsAfterPA - DIVIDEND_ALLOWANCE);

                const propertyAfterPA = Math.max(0, propertyIncome - Math.max(0, remainingPA - paUsed));
                const taxableProperty = propertyAfterPA;

                return {
                    remainingPA,
                    isHigherRate,
                    taxableSavings,
                    taxableDividends,
                    taxableProperty,
                    savingsTax: taxableSavings * savingsRate * rateMultiplier,
                    dividendTax: taxableDividends * dividendRate * rateMultiplier,
                    propertyTax: taxableProperty * propertyRate * rateMultiplier,
                    totalTax: (taxableSavings * savingsRate + taxableDividends * dividendRate + taxableProperty * propertyRate) * rateMultiplier,
                    dividendRate,
                    savingsRate,
                    propertyRate,
                    SAVINGS_ALLOWANCE,
                    DIVIDEND_ALLOWANCE
                };
            }

            const preAB = calcUnearnedTax(baselinePA, baselineBasicThreshold, false);
            const postAB = calcUnearnedTax(reformPA, reformBasicThreshold, true);

            const allRows = [
                { section: 'Your income' },
                { label: 'Earned income (employment/pension)', preAB: grossIncome, postAB: grossIncome },
                { label: 'Personal allowance', preAB: baselinePA, postAB: reformPA },
                { label: 'Remaining PA for unearned income', preAB: preAB.remainingPA, postAB: postAB.remainingPA },
                { section: 'Unearned income' },
                { label: 'Savings interest', preAB: savingsInterest, postAB: savingsInterest },
                { label: 'Dividend income', preAB: dividends, postAB: dividends },
                { label: 'Property income', preAB: propertyIncome, postAB: propertyIncome },
                { label: 'Total unearned', preAB: totalUnearned, postAB: totalUnearned },
                { section: 'Taxable amounts (after PA & allowances)' },
                { label: 'Taxable savings (after PA & £' + preAB.SAVINGS_ALLOWANCE + ' allowance)', preAB: preAB.taxableSavings, postAB: postAB.taxableSavings },
                { label: 'Taxable dividends (after PA & £' + preAB.DIVIDEND_ALLOWANCE + ' allowance)', preAB: preAB.taxableDividends, postAB: postAB.taxableDividends },
                { label: 'Taxable property (after PA)', preAB: preAB.taxableProperty, postAB: postAB.taxableProperty },
                { section: 'Tax calculation' },
                { label: 'Rate band', preAB: preAB.isHigherRate ? 'Higher rate' : 'Basic rate', postAB: postAB.isHigherRate ? 'Higher rate' : 'Basic rate', isText: true },
                { label: 'Tax on savings (' + (preAB.savingsRate * 100) + '% → ' + (postAB.savingsRate * 100 * 1.05).toFixed(1) + '%)', preAB: preAB.savingsTax, postAB: postAB.savingsTax },
                { label: 'Tax on dividends (' + (preAB.dividendRate * 100).toFixed(2) + '% → ' + (postAB.dividendRate * 100 * 1.05).toFixed(2) + '%)', preAB: preAB.dividendTax, postAB: postAB.dividendTax },
                { label: 'Tax on property (' + (preAB.propertyRate * 100) + '% → ' + (postAB.propertyRate * 100 * 1.05).toFixed(1) + '%)', preAB: preAB.propertyTax, postAB: postAB.propertyTax },
                { separator: true },
                { label: 'Total unearned income tax', preAB: preAB.totalTax, postAB: postAB.totalTax, highlight: true },
            ];

            const termsSuffix = getTermsSuffix();
            let tableHtml = `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle} text-align: left; width: 50%;">Item</th>
                            <th style="${thStyle} width: 16.67%;">Pre-AB${termsSuffix}</th>
                            <th style="${thStyle} width: 16.67%;">Post-AB${termsSuffix}</th>
                            <th style="${thStyle} width: 16.67%;">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allRows.forEach(r => {
                if (r.section) {
                    tableHtml += `<tr><td colspan="4" style="padding: 12px 8px 6px; font-weight: 600; font-size: 0.85rem; color: #475569; background: #f8fafc;">${r.section}</td></tr>`;
                } else if (r.separator) {
                    tableHtml += `<tr><td colspan="4" style="padding: 4px;"></td></tr>`;
                } else if (r.isText) {
                    tableHtml += `
                        <tr>
                            <td style="${labelStyle}">${r.label}</td>
                            <td style="${tdStyle}">${r.preAB}</td>
                            <td style="${tdStyle}">${r.postAB}</td>
                            <td style="${tdStyle}">-</td>
                        </tr>
                    `;
                } else {
                    const preABReal = toRealTerms(r.preAB, year);
                    const postABReal = toRealTerms(r.postAB, year);
                    const diff = postABReal - preABReal;
                    const rowStyle = r.highlight ? 'background: #fef2f2;' : '';
                    tableHtml += `
                        <tr style="${rowStyle}">
                            <td style="${labelStyle} ${r.highlight ? 'font-weight: 600; color: #1e293b;' : ''}">${r.label}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(preABReal)}</td>
                            <td style="${tdStyle}">£${d3.format(',.0f')(postABReal)}</td>
                            <td style="${tdStyle}">${formatDiff(diff)}</td>
                        </tr>
                    `;
                }
            });

            tableHtml += `</tbody></table>`;

            container.innerHTML = `
                <div style="font-size: 0.95rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: #334155;">Unearned income tax</div>
                            <div style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">5% increase in tax on dividends, savings, and property income</div>
                        </div>
                    </div>
                    ${tableHtml}
                    <div style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">
                        <strong>How it works:</strong> The Autumn Budget increased taxes on unearned income by 5% and froze the personal allowance. Pre-AB, the PA would be £${d3.format(',.0f')(baselinePA)}; post-AB it's frozen at £${d3.format(',.0f')(reformPA)}. Your PA is first used by earned income; any remainder shelters unearned income.
                    </div>
                </div>
            `;
        }

        // Debounce function for smoother slider interaction
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedFetch = debounce(fetchData, 50);

        // Event listeners - use 'input' for live updates while dragging
        document.querySelectorAll('.controls input[type="range"]').forEach(el => {
            el.addEventListener('input', debouncedFetch);
        });
        document.querySelectorAll('.controls select').forEach(el => {
            el.addEventListener('change', fetchData);
        });

        // Download SVG
        function downloadSVG() {
            const svg = document.querySelector('#chart svg');
            if (!svg) return;

            // Clone SVG and add styles inline
            const clone = svg.cloneNode(true);
            clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');

            // Add inline styles for proper rendering
            const style = document.createElementNS('http://www.w3.org/2000/svg', 'style');
            style.textContent = `
                .axis text { fill: #64748b; font-size: 11px; font-family: Roboto, sans-serif; }
                .axis path, .axis line { stroke: #e2e8f0; }
                .grid line { stroke: #f1f5f9; }
            `;
            clone.insertBefore(style, clone.firstChild);

            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(clone);
            const blob = new Blob([svgString], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'lifetime-policy-impact.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Download CSV
        function downloadCSV() {
            if (!currentData.length) return;

            const headers = [
                'age', 'year', 'gross_income', 'income_tax', 'national_insurance',
                'student_loan_payment', 'student_loan_debt_remaining', 'baseline_net_income',
                'impact_rail_fare_freeze', 'impact_fuel_duty_freeze', 'impact_threshold_freeze',
                'impact_unearned_income_tax', 'impact_salary_sacrifice_cap', 'impact_sl_threshold_freeze',
                'net_policy_impact'
            ];

            const rows = currentData.map(row => {
                const netImpact = reforms.reduce((sum, r) => sum + (row[r.key] || 0), 0);
                return [
                    row.age, row.year, row.gross_income, row.income_tax, row.national_insurance,
                    row.student_loan_payment, row.student_loan_debt_remaining, row.baseline_net_income,
                    row.impact_rail_fare_freeze, row.impact_fuel_duty_freeze, row.impact_threshold_freeze,
                    row.impact_unearned_income_tax, row.impact_salary_sacrifice_cap, row.impact_sl_threshold_freeze,
                    netImpact
                ].join(',');
            });

            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'lifetime-policy-impact.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Download button listeners
        document.getElementById('download-svg').addEventListener('click', downloadSVG);
        document.getElementById('download-csv').addEventListener('click', downloadCSV);

        // Real terms toggle listener
        const realTermsToggle = document.getElementById('real-terms-toggle');
        const nominalLabel = document.getElementById('nominal-label');
        const realLabel = document.getElementById('real-label');

        realTermsToggle.addEventListener('change', () => {
            showRealTerms = realTermsToggle.checked;
            // Update label styling
            nominalLabel.classList.toggle('active', !showRealTerms);
            realLabel.classList.toggle('active', showRealTerms);
            // Re-render everything with new terms
            renderChart(true);
            renderActiveDetailChart();
        });

        // Initial load
        initSliders();
        fetchData();
    </script>
</body>
</html>
